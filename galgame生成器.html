<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galgame ç”Ÿæˆå™¨ V2.4</title>
    <style>
      /* --- å…¨å±€ä¸»é¢˜ (æ¸…æ–°ç§‘æŠ€é£ V2.4 Fixed) --- */
      :root {
        --bg-gradient: linear-gradient(135deg, #f6f8fb 0%, #e2ebf0 100%);
        --accent-color: #74b9ff;
        --soft-pink: #ff7675;
        --soft-purple: #a29bfe;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: 1px solid rgba(255, 255, 255, 0.9);
        --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
        --rounding: 20px;
      }

      body {
        font-family: 'Nunito', 'Microsoft YaHei', sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg-gradient);
        background-attachment: fixed;
        color: var(--text-main);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-bottom: 100px;
        user-select: none;
        background-image: radial-gradient(rgba(116, 185, 255, 0.15) 1px, transparent 1px);
        background-size: 30px 30px;
      }

      /* --- 1. èˆå°åŒºåŸŸ --- */
      #stage-container {
        margin-top: 30px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 24px;
        box-shadow: 0 12px 40px rgba(31, 38, 135, 0.1);
        backdrop-filter: blur(10px);
      }

      #stage-wrapper {
        position: relative;
        width: 1280px;
        height: 720px;
        overflow: hidden;
        background: #000;
        border-radius: 16px;
        box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      #stage-wrapper:fullscreen #btn-fs {
        display: none;
      }

      .layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .hidden {
        display: none !important;
      }

      /* æ ¸å¿ƒä¿®å¤ç‚¹ 1ï¼šç§»é™¤å›ºå®šçš„ object-fit: coverã€‚è®© JS åŠ¨æ€è®¾ç½®ã€‚ */
      #bg-layer-img,
      #bg-layer-video {
        width: 100%;
        height: 100%;
        /* åˆå§‹ä¸ºç©ºï¼Œç”± JS å†³å®šæ˜¯ cover è¿˜æ˜¯ contain */
        object-fit: initial;
        transition: object-fit 0.3s;
      }

      /* ç«‹ç»˜å±‚ */
      #char-layer {
        z-index: 10;
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
        padding-left: 40px;
        height: 100%;
      }
      #char-img {
        max-height: 85%;
        max-width: 35%;
        /* ç«‹ç»˜å¿…é¡»æ˜¯ containï¼Œç¡®ä¿å®Œæ•´æ˜¾ç¤ºï¼Œé¿å…è£å‰ª */
        object-fit: contain;
        filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
        transform-origin: bottom center;
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
      }
      .char-enter-anim {
        animation: slideInLeft 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }
      @keyframes slideInLeft {
        from {
          transform: translate(var(--tx), var(--ty)) scale(var(--scale));
          opacity: 0;
        }
        to {
          transform: translate(var(--tx), var(--ty)) scale(var(--scale));
          opacity: var(--opacity);
        }
      }

      /* UIå±‚ */
      #ui-layer {
        z-index: 20;
      }
      .dialogue-box {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 92%;
        height: 170px;
        padding: 25px 35px;
        box-sizing: border-box;
        pointer-events: auto;
        display: flex;
        flex-direction: column;
        transition: all 0.3s;
      }

      .style-default {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 24px;
        border: 2px solid #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        color: #444;
        backdrop-filter: blur(15px);
      }
      .style-default .name-tag {
        background: var(--soft-purple);
        color: white;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(162, 155, 254, 0.4);
      }
      .style-tech {
        background: rgba(16, 20, 30, 0.9);
        border: 2px solid #00cec9;
        border-radius: 8px;
        color: #00cec9;
        box-shadow: 0 0 15px rgba(0, 206, 201, 0.2);
      }
      .style-tech .name-tag {
        background: #00cec9;
        color: black;
        border-radius: 4px;
      }
      .style-sweet {
        background: #fff5f7;
        border: 3px dashed #ff7675;
        border-radius: 30px;
        color: #d63031;
      }
      .style-sweet .name-tag {
        background: #ff7675;
        color: white;
        border-radius: 50px;
        border: 2px solid white;
      }
      .style-retro {
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9));
        border: 2px solid #aaa;
        border-radius: 4px;
        color: #eee;
      }
      .style-retro .name-tag {
        color: #f1c40f;
        padding: 0;
        text-shadow: 1px 1px black;
      }

      .name-tag {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 10px;
        padding: 4px 18px;
        display: inline-block;
        width: fit-content;
      }
      .text-content {
        font-size: 22px;
        line-height: 1.6;
        font-weight: 600;
        min-height: 1.6em;
      }

      #hud-controls {
        position: absolute;
        bottom: 115px;
        right: 20px;
        transform: translateY(50%);
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 100;
        pointer-events: auto;
        transition: opacity 0.3s;
      }
      .hud-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.6);
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .hud-btn:hover {
        background: var(--accent-color);
        transform: scale(1.15);
        border-color: white;
      }
      .hud-btn.off {
        background: var(--soft-pink);
        opacity: 0.8;
        text-decoration: line-through;
      }

      /* --- 2. ç¼–è¾‘å™¨ --- */
      .main-content {
        width: 1280px;
        margin-top: 25px;
        display: none;
        gap: 25px;
      }
      .main-content.active {
        display: grid;
      }
      .main-content.grid-2-flow {
        grid-template-columns: 360px 1fr;
      }

      .panel {
        background: var(--glass-bg);
        border: var(--glass-border);
        border-radius: var(--rounding);
        padding: 25px;
        box-shadow: var(--shadow-card);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
      }
      h2 {
        font-size: 18px;
        color: var(--text-main);
        margin: 0 0 20px 0;
        padding-left: 12px;
        border-left: 5px solid var(--accent-color);
        font-weight: 800;
      }

      label {
        font-size: 13px;
        font-weight: 700;
        color: var(--text-sub);
        margin: 15px 0 8px 0;
        display: block;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 15px;
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        background: rgba(255, 255, 255, 0.8);
        color: var(--text-main);
        font-family: inherit;
        font-size: 14px;
        box-sizing: border-box;
        transition: all 0.2s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent-color);
        background: #fff;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        background: white;
        color: var(--text-main);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        color: var(--accent-color);
      }
      .btn-primary {
        background: var(--accent-color);
        color: white;
        width: 100%;
      }
      .btn-danger {
        background: var(--soft-pink);
        color: white;
      }

      .color-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 8px;
      }
      .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(0, 0, 0, 0.05);
      }
      .color-swatch.selected {
        border-color: var(--text-main);
        transform: scale(1.1);
      }

      #flowchart-panel {
        max-height: 70vh;
      }
      #flowchart-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 5px;
        margin: -5px;
        scrollbar-width: thin;
      }
      .flow-node {
        background: white;
        border-radius: 14px;
        padding: 12px 15px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: grab;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .flow-node:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(116, 185, 255, 0.15);
      }
      .flow-node.active {
        background: #f0f9ff;
        border: 1px solid var(--accent-color);
      }
      .flow-node.dragging {
        opacity: 0.4;
        border: 2px dashed var(--accent-color);
        background: #f1f2f6;
      }

      @keyframes flashHighlight {
        0% {
          background: #ffeaa7;
          transform: scale(1.02);
        }
        50% {
          background: #ffffff;
        }
        100% {
          background: #f0f9ff;
          transform: scale(1);
        }
      }
      .flash-anim {
        animation: flashHighlight 0.6s ease-out 2;
      }

      .drag-handle {
        color: #ccc;
        font-size: 18px;
        cursor: grab;
      }
      .flow-idx {
        font-size: 12px;
        font-weight: 800;
        color: #b2bec3;
        background: #f5f6fa;
        padding: 2px 6px;
        border-radius: 6px;
      }
      .flow-role {
        font-size: 12px;
        font-weight: 700;
        color: white;
        padding: 3px 8px;
        border-radius: 20px;
        max-width: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .flow-text {
        flex: 1;
        font-size: 14px;
        color: var(--text-sub);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .flow-del {
        opacity: 0;
        color: #ff7675;
        background: transparent;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
      }
      .flow-node:hover .flow-del {
        opacity: 1;
      }

      .char-card img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        object-position: top center;
        border-radius: 50%;
        border: 4px solid transparent;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      #bottom-nav {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: 8px 10px;
        border-radius: 50px;
        display: flex;
        gap: 5px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.5);
        z-index: 900;
      }
      .nav-btn {
        background: transparent;
        color: var(--text-sub);
        border: none;
        padding: 10px 24px;
        cursor: pointer;
        border-radius: 30px;
        font-weight: 700;
        font-size: 15px;
        transition: 0.3s;
      }
      .nav-btn.active {
        background: var(--text-main);
        color: white;
        box-shadow: 0 4px 12px rgba(45, 52, 54, 0.3);
      }

      #trimmer-modal .trim-content {
        background: white;
        padding: 30px;
        border-radius: 24px;
        width: 800px;
        text-align: center;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      }
      #trim-preview {
        background: #000;
        border-radius: 12px;
        height: 50vh;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 15px 0;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
        vertical-align: middle;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #dfe6e9;
        transition: 0.3s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: '';
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--accent-color);
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }

      .opt-row {
        background: #fff;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #eee;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .opt-label {
        font-size: 11px;
        color: #aaa;
        font-weight: 800;
        text-transform: uppercase;
        white-space: nowrap;
      }

      /* æ‹–æ”¾æ ·å¼ */
      .drag-area {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 10px;
        transition: border-color 0.2s;
        pointer-events: auto; /* ç¡®ä¿å¯ä»¥æ¥æ”¶æ‹–æ”¾äº‹ä»¶ */
        position: relative; /* ç¡®ä¿å±‚çº§æ­£ç¡® */
        z-index: 1; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
      }
      .drag-area.drag-over {
        border-color: var(--accent-color);
        background: #f0f9ff;
      }
    </style>
  </head>
  <body>
    <div id="stage-container">
      <div id="stage-wrapper" onclick="handleStageClick()" ondblclick="exitFS()">
        <div
          id="affinity-feedback"
          style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: 900;
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            text-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
          "
        ></div>
        <img id="bg-layer-img" class="layer" />
        <video id="bg-layer-video" class="layer hidden" loop playsinline></video>
        <audio id="bgm-player" loop></audio>

        <div id="char-layer" class="layer"><img id="char-img" class="hidden" /></div>
        <div
          id="choice-layer"
          class="layer hidden"
          style="
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            z-index: 30;
            pointer-events: auto;
          "
        ></div>

        <div id="ui-layer" class="layer">
          <div class="dialogue-box style-default" id="dialogue-box">
            <div class="name-tag" id="ui-name"></div>
            <div class="text-content" id="ui-text"></div>
          </div>
        </div>

        <div id="hud-controls">
          <div class="hud-btn" onclick="event.stopPropagation(); toggleLayer('char-layer', this)" title="æ˜¾ç¤º/éšè—ç«‹ç»˜">
            ğŸ‘ï¸
          </div>
          <div
            class="hud-btn"
            onclick="event.stopPropagation(); toggleLayer('ui-layer', this)"
            title="æ˜¾ç¤º/éšè—å¯¹è¯æ¡† (å«æŒ‰é’®)"
          >
            ğŸ’¬
          </div>
        </div>
        <button
          id="btn-fs"
          onclick="event.stopPropagation(); toggleFS()"
          style="
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            border-radius: 12px;
            padding: 6px 14px;
            backdrop-filter: blur(4px);
            cursor: pointer;
            font-weight: bold;
          "
        >
          â›¶ å…¨å±
        </button>
      </div>
    </div>

    <div id="tab-editor" class="main-content grid-2-flow active">
      <div class="left-flow-column">
        <div id="flowchart-panel" class="panel">
          <h2>ğŸŒ³ å‰§æœ¬æµè½¬å›¾</h2>
          <div id="flowchart-container"></div>
          <button class="btn btn-primary" style="margin-top: 15px" onclick="addNewScene()">+ åœ¨ä¸‹æ–¹æ’å…¥å°è¯è¡Œ</button>
        </div>
        <div class="panel">
          <h2>ğŸ”€ é€»è¾‘ä¸è·³è½¬</h2>
          <label>â­ï¸ çº¿æ€§è·³è½¬è‡³ (è¡Œå·)</label>
          <input
            type="number"
            id="inp-next"
            min="1"
            placeholder="é»˜è®¤ä¸‹ä¸€è¡Œ"
            onchange="saveData()"
            style="width: 120px"
          />
          <label>ğŸ’¡ åˆ†æ”¯é€‰é¡¹</label>
          <button class="btn" onclick="addOpt()" style="width: 100%; margin-bottom: 10px; border: 1px dashed #ccc">
            + æ·»åŠ é€‰é¡¹
          </button>
          <div id="opt-list" style="display: flex; flex-direction: column; gap: 8px"></div>
        </div>
      </div>

      <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
          <h2 style="margin: 0; border: none; padding: 0">âœï¸ å¯¼æ¼”æ§åˆ¶å°</h2>
          <span
            id="editor-idx"
            style="
              font-size: 14px;
              font-weight: bold;
              color: var(--accent-color);
              background: #f0f9ff;
              padding: 6px 12px;
              border-radius: 8px;
            "
            >è¡Œ 1</span
          >
        </div>

        <div
          style="
            background: #f0f9ff;
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #dbeeff;
            display: flex;
            align-items: center;
            gap: 10px;
          "
        >
          <span style="font-size: 13px; font-weight: bold; color: #1565c0">ğŸ…°ï¸ æ–‡å­—é€Ÿåº¦</span>
          <input
            type="range"
            id="inp-global-speed"
            min="0"
            max="100"
            step="10"
            value="50"
            oninput="updateGlobalSpeed(this.value)"
            style="flex: 1"
          />
          <span
            id="val-global-speed"
            style="font-size: 12px; font-family: monospace; color: #1565c0; width: 40px; text-align: right"
            >ä¸­é€Ÿ</span
          >
        </div>

        <label>ğŸ—£ï¸ è¯´è¯è§’è‰²</label>
        <select id="inp-role-id" onchange="saveData()"></select>

        <label>ğŸ’¬ å°è¯å†…å®¹</label>
        <textarea id="inp-text" rows="4" onchange="saveData()"></textarea>

        <label>ğŸ–¼ï¸ èƒŒæ™¯ç”»é¢ (å¯æ‹–å…¥ **å›¾ç‰‡/è§†é¢‘** æ–‡ä»¶)</label>
        <div id="drag-bg" class="drag-area" style="display: flex; gap: 8px">
          <select id="inp-bg-type" onchange="toggleMedia();saveData();" style="flex: 1">
            <option value="inherit">â†ªï¸ ä¿æŒä¸å˜</option>
            <option value="image">ğŸ–¼ï¸ å›¾ç‰‡</option>
            <option value="video">ğŸ¥ è§†é¢‘</option>
          </select>
          <button class="btn" id="btn-up-bg" onclick="trigUp('bg')" style="width: 50px">ğŸ“‚</button>
        </div>
        <div
          id="video-control"
          style="display: none; margin-top: 10px; background: #e3f2fd; padding: 10px; border-radius: 10px"
        >
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
            <span id="mute-status-text" style="font-size: 12px; color: #1565c0; font-weight: bold">ğŸ”Š åŸå£°</span>
            <label class="toggle-switch"
              ><input type="checkbox" id="inp-video-mute" checked onchange="updateMuteText(); saveData()" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div style="display: flex; align-items: center; gap: 10px">
            <span style="font-size: 12px; color: #1565c0">éŸ³é‡</span>
            <input
              type="range"
              id="inp-video-vol"
              min="0"
              max="1"
              step="0.1"
              value="1"
              oninput="updateVolume('bg', this.value); saveData()"
            />
          </div>
        </div>

        <label>ğŸµ èƒŒæ™¯éŸ³ä¹ (å¯æ‹–å…¥ **éŸ³é¢‘** æ–‡ä»¶)</label>
        <div id="drag-bgm" class="drag-area" style="display: flex; gap: 8px">
          <select id="inp-bgm-type" onchange="toggleMedia();saveData();" style="flex: 1">
            <option value="inherit">â†ªï¸ ä¿æŒä¸å˜</option>
            <option value="file">ğŸµ æ’­æ”¾</option>
            <option value="stop">ğŸ”‡ åœæ­¢</option>
          </select>
          <button class="btn" id="btn-up-bgm" onclick="trigUp('bgm')" style="width: 50px">ğŸ“‚</button>
        </div>
        <div
          id="bgm-control"
          style="
            display: none;
            margin-top: 8px;
            background: #f3e5f5;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #e1bee7;
          "
        >
          <div style="display: flex; align-items: center; gap: 10px">
            <span style="font-size: 12px; color: #8e24aa">éŸ³é‡</span>
            <input
              type="range"
              id="inp-bgm-vol"
              min="0"
              max="1"
              step="0.1"
              value="1"
              oninput="updateVolume('bgm', this.value); saveData()"
            />
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 15px; margin-top: 25px; border: 1px solid #eee">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 13px;
              font-weight: bold;
              color: #666;
              margin-bottom: 10px;
            "
          >
            <span>ğŸ‘» ç«‹ç»˜æ§åˆ¶ (Transform)</span>
            <div style="display: flex; align-items: center; gap: 8px">
              <label for="inp-char-visible" style="margin: 0; cursor: pointer">æ˜¾ç¤º</label>
              <label class="toggle-switch"
                ><input type="checkbox" id="inp-char-visible" checked onchange="saveData()" /><span
                  class="slider"
                ></span
              ></label>
            </div>
          </div>
          <div style="display: flex; gap: 15px; margin-bottom: 10px">
            <div style="flex: 1">
              <label style="margin: 0 0 5px 0; font-size: 12px"
                >æ°´å¹³ X: <span id="val-x" style="color: var(--accent-color)">0</span></label
              >
              <input
                type="range"
                id="inp-x"
                min="-500"
                max="500"
                step="10"
                value="0"
                oninput="updateSlider('x',this.value); saveData()"
              />
            </div>
            <div style="flex: 1">
              <label style="margin: 0 0 5px 0; font-size: 12px"
                >å‚ç›´ Y: <span id="val-y" style="color: var(--accent-color)">0</span></label
              >
              <input
                type="range"
                id="inp-y"
                min="-200"
                max="200"
                step="10"
                value="0"
                oninput="updateSlider('y',this.value); saveData()"
              />
            </div>
          </div>
          <div style="display: flex; gap: 15px">
            <div style="flex: 1">
              <label style="margin: 0 0 5px 0"
                >ç¼©æ”¾ <span id="val-scale" style="color: var(--accent-color)">1.0</span></label
              ><input
                type="range"
                id="inp-scale"
                min="0.5"
                max="1.5"
                step="0.1"
                value="1.0"
                oninput="updateSlider('scale',this.value); saveData()"
              />
            </div>
            <div style="flex: 1">
              <label style="margin: 0 0 5px 0"
                >é€æ˜ <span id="val-opacity" style="color: var(--accent-color)">1.0</span></label
              ><input
                type="range"
                id="inp-opacity"
                min="0.1"
                max="1.0"
                step="0.1"
                value="1.0"
                oninput="updateSlider('opacity',this.value); saveData()"
              />
            </div>
          </div>
          <button
            class="btn"
            onclick="applyToAllSameRole()"
            style="
              width: 100%;
              margin-top: 12px;
              font-size: 13px;
              background: #e3f2fd;
              color: #1565c0;
              border: 1px solid #bbdefb;
            "
          >
            âœ¨ åº”ç”¨ä½ç½®/å¤§å°è‡³è¯¥è§’è‰²æ‰€æœ‰è¡Œ
          </button>
        </div>

        <input type="file" id="file-bg" class="hidden" accept="image/*,video/*,.mkv" onchange="handleFile(this,'bg')" />
        <input type="file" id="file-bgm" class="hidden" accept="audio/*" onchange="handleFile(this,'bgm')" />
      </div>
    </div>

    <div id="tab-roles" class="main-content">
      <div class="panel" style="grid-column: 1 / -1">
        <h2>ğŸ‘¥ æ¼”å‘˜æ‹›å‹Ÿ</h2>
        <div
          style="
            display: flex;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #eee;
            flex-wrap: wrap;
          "
        >
          <div style="flex: 1; min-width: 150px">
            <label style="margin-top: 0">å§“å</label><input type="text" id="new-role-name" placeholder="Role Name" />
          </div>
          <div style="flex: 1; min-width: 150px">
            <label style="margin-top: 0">å¯¹è¯æ¡†é£æ ¼</label
            ><select id="new-role-style">
              <option value="default">ğŸ¬ æ¸…æ–°é»˜è®¤</option>
              <option value="tech">ğŸ¤– èµ›åšç§‘æŠ€</option>
              <option value="sweet">ğŸ­ ç”œèœœç³–æœ</option>
              <option value="retro">ğŸ“œ ç»å…¸å¤å¤</option>
            </select>
          </div>
          <div style="flex: 1; min-width: 200px">
            <label style="margin-top: 0">ä¸»é¢˜è‰²</label>
            <div class="color-grid" id="color-palette"></div>
            <input type="hidden" id="new-role-color" value="#ffffff" />
          </div>
          <div style="flex: 1; min-width: 200px">
            <label style="margin-top: 0">ç«‹ç»˜ (å¯é€‰)</label><input type="file" id="new-role-img" accept="image/*" />
          </div>
          <div style="width: 100%"><button class="btn btn-primary" onclick="createRole()">+ åˆ›å»ºè§’è‰²</button></div>
        </div>
        <div
          id="char-grid"
          style="
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
          "
        ></div>
        <button class="btn btn-danger" onclick="resetAff()" style="margin-top: 30px; width: 100%">
          é‡ç½®æ‰€æœ‰å¥½æ„Ÿåº¦
        </button>
      </div>
    </div>

    <div id="bottom-nav">
      <button class="nav-btn active" onclick="switchTab('editor')">ğŸ“ å‰§æœ¬</button>
      <button class="nav-btn" onclick="switchTab('roles')">ğŸ‘¥ è§’è‰²</button>
      <div style="width: 1px; background: #ddd; margin: 0 5px"></div>
      <button class="nav-btn" onclick="exportProj()">ğŸ’¾ å¯¼å‡º</button>
      <button class="nav-btn" onclick="document.getElementById('imp-f').click()">ğŸ“‚ å¯¼å…¥</button>
      <input type="file" id="imp-f" class="hidden" accept=".json" onchange="importProj(this)" />
    </div>

    <div
      id="trimmer-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      "
    >
      <div class="trim-content">
        <h3>âœ‚ï¸ åª’ä½“å‰ªè¾‘</h3>
        <div id="trim-preview"></div>
        <div style="margin: 15px; font-family: monospace">
          Start: <span id="t-start" style="color: var(--accent-color); font-weight: bold">0.00</span>s | End:
          <span id="t-end" style="color: var(--accent-color); font-weight: bold">--</span>s
        </div>
        <div style="display: flex; justify-content: center; gap: 15px">
          <button class="btn" onclick="setTrim('s')">ğŸ“ è®¾ä¸ºå¼€å§‹</button
          ><button class="btn" onclick="setTrim('e')">ğŸ è®¾ä¸ºç»“æŸ</button>
        </div>
        <div
          style="
            margin-top: 25px;
            border-top: 1px solid #eee;
            padding-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
          "
        >
          <button class="btn" onclick="closeTrim()">å–æ¶ˆ</button
          ><button class="btn btn-primary" onclick="confirmTrim()">ç¡®è®¤</button>
        </div>
      </div>
    </div>

    <script>
      const COLORS = [
        '#ff7675',
        '#fd79a8',
        '#e84393',
        '#fab1a0',
        '#ffeaa7',
        '#fdcb6e',
        '#e17055',
        '#00b894',
        '#00cec9',
        '#74b9ff',
        '#0984e3',
        '#6c5ce7',
        '#a29bfe',
        '#dfe6e9',
        '#636e72',
        '#2d3436',
      ];
      let project = {
        globalSpeed: 50, // 0=Instant, 100=Slow
        roles: {
          narrator: { id: 'narrator', name: 'æ—ç™½', color: '#ffffff', src: '', affinity: 0, dialogueStyle: 'default' },
          npc_1: { id: 'npc_1', name: 'è·¯äººç”²', color: '#b0b0b0', src: '', affinity: 0, dialogueStyle: 'default' },
        },
        scripts: [
          {
            roleId: 'narrator',
            text: 'æ¬¢è¿ä½¿ç”¨ Galgame ç”Ÿæˆå™¨ V2.4ï¼',
            charScale: 1.0,
            charOpacity: 1.0,
            charX: 0,
            charY: 0,
            charVisible: false,
            bgType: 'image',
            bgSrc: '',
            bgS: 0,
            bgE: null,
            bgMuted: true,
            bgVol: 1,
            bgmType: 'stop',
            bgmSrc: '',
            bgmS: 0,
            bgmE: null,
            bgmVol: 1,
            next: null,
            opts: [],
          },
        ],
      };
      let curIdx = 0,
        trim = { active: false, file: null, type: '', media: '', s: 0, e: null, player: null };
      let dragSrcIdx = -1;
      let typewriter = { timer: null, fullText: '', isTyping: false };
      const STAGE_RATIO = 1280 / 720; // 16:9 èˆå°æ¯”ä¾‹

      window.onload = () => {
        renderPalette();
        renderGame(0);
        updateGlobalSpeedUI();
        setupDragAndDrop();
        setupVideoErrorHandling();
      };

      // ä¿®å¤ï¼šæ·»åŠ è§†é¢‘é”™è¯¯å¤„ç†ï¼Œæ£€æµ‹MKVç­‰ä¸æ”¯æŒçš„æ ¼å¼
      function setupVideoErrorHandling() {
        const vid = document.getElementById('bg-layer-video');
        const aud = document.getElementById('bgm-player');

        vid.addEventListener('error', e => {
          const error = vid.error;
          if (error) {
            let errorMsg = 'è§†é¢‘åŠ è½½å¤±è´¥ã€‚';
            if (error.code === error.MEDIA_ERR_SRC_NOT_SUPPORTED) {
              errorMsg = 'è§†é¢‘æ ¼å¼ä¸æ”¯æŒã€‚æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒMKVæ ¼å¼ï¼Œè¯·å°è¯•è½¬æ¢ä¸ºMP4æˆ–WebMæ ¼å¼ã€‚';
            } else if (error.code === error.MEDIA_ERR_DECODE) {
              errorMsg = 'è§†é¢‘è§£ç å¤±è´¥ã€‚å¯èƒ½æ˜¯ç¼–ç æ ¼å¼ä¸å…¼å®¹ï¼Œè¯·å°è¯•è½¬æ¢ä¸ºH.264ç¼–ç çš„MP4æ ¼å¼ã€‚';
            } else if (error.code === error.MEDIA_ERR_NETWORK) {
              errorMsg = 'è§†é¢‘åŠ è½½ç½‘ç»œé”™è¯¯ã€‚';
            }
            console.error('è§†é¢‘æ’­æ”¾é”™è¯¯:', errorMsg, error);
            alert(errorMsg);
          }
        });

        vid.addEventListener('loadedmetadata', () => {
          // æ£€æŸ¥è§†é¢‘æ˜¯å¦çœŸçš„å¯ä»¥æ’­æ”¾
          if (vid.readyState < 2) {
            console.warn('è§†é¢‘å…ƒæ•°æ®åŠ è½½ä¸å®Œæ•´ï¼Œå¯èƒ½æ ¼å¼ä¸æ”¯æŒ');
          }
        });

        aud.addEventListener('error', e => {
          const error = aud.error;
          if (error) {
            alert('éŸ³é¢‘åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒã€‚');
            console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error);
          }
        });
      }

      document.addEventListener('keydown', e => {
        if (e.code === 'Space' && !e.repeat) {
          if (document.fullscreenElement) {
            e.preventDefault();
            handleStageClick();
          }
        }
      });

      function handleStageClick() {
        const isFullscreen = document.fullscreenElement;
        const hud = document.getElementById('hud-controls');

        if (!isFullscreen) {
          if (hud.classList.contains('hidden')) {
            hud.classList.remove('hidden');
            return;
          }
        }

        if (typewriter.isTyping) {
          finishTypewriter();
        } else {
          gameNext();
        }
      }

      function exitFS() {
        if (document.fullscreenElement) document.exitFullscreen();
      }

      /* --- æ‹–æ”¾é€»è¾‘ --- */
      function setupDragAndDrop() {
        const dragBg = document.getElementById('drag-bg');
        const dragBgm = document.getElementById('drag-bgm');

        if (!dragBg || !dragBgm) {
          console.error('æ‹–æ”¾åŒºåŸŸå…ƒç´ æœªæ‰¾åˆ°');
          return;
        }

        // ä¿®å¤ï¼šæ·»åŠ  dragenter äº‹ä»¶ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰äº‹ä»¶éƒ½æ­£ç¡®é˜»æ­¢é»˜è®¤è¡Œä¸º
        dragBg.addEventListener('dragenter', e => {
          e.preventDefault();
          e.stopPropagation();
          dragBg.classList.add('drag-over');
        });
        dragBg.addEventListener('dragover', e => handleDragOver(e, dragBg));
        dragBg.addEventListener('dragleave', e => handleDragLeave(e, dragBg));
        dragBg.addEventListener('drop', e => handleDrop(e, 'bg', dragBg));

        dragBgm.addEventListener('dragenter', e => {
          e.preventDefault();
          e.stopPropagation();
          dragBgm.classList.add('drag-over');
        });
        dragBgm.addEventListener('dragover', e => handleDragOver(e, dragBgm));
        dragBgm.addEventListener('dragleave', e => handleDragLeave(e, dragBgm));
        dragBgm.addEventListener('drop', e => handleDrop(e, 'bgm', dragBgm));

        // ä¿®å¤ï¼šé˜»æ­¢å…¨å±€çš„æ‹–æ”¾é»˜è®¤è¡Œä¸ºï¼Œé¿å…æµè§ˆå™¨æ‰“å¼€æ–‡ä»¶
        document.addEventListener('dragover', e => {
          // å¦‚æœæ‹–æ”¾ä¸åœ¨æˆ‘ä»¬çš„æ‹–æ”¾åŒºåŸŸå†…ï¼Œæ‰é˜»æ­¢é»˜è®¤è¡Œä¸º
          if (!e.target.closest('.drag-area')) {
            e.preventDefault();
          }
        });
        document.addEventListener('drop', e => {
          // å¦‚æœæ‹–æ”¾ä¸åœ¨æˆ‘ä»¬çš„æ‹–æ”¾åŒºåŸŸå†…ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸º
          if (!e.target.closest('.drag-area')) {
            e.preventDefault();
          }
        });
      }

      function handleDragOver(e, target) {
        e.preventDefault();
        e.stopPropagation();
        target.classList.add('drag-over');
      }

      function handleDragLeave(e, target) {
        e.preventDefault();
        e.stopPropagation();
        // ä¿®å¤ï¼šåªæœ‰å½“é¼ æ ‡çœŸæ­£ç¦»å¼€æ‹–æ”¾åŒºåŸŸæ—¶æ‰ç§»é™¤æ ·å¼
        // æ£€æŸ¥ç›¸å…³ç›®æ ‡æ˜¯å¦è¿˜åœ¨æ‹–æ”¾åŒºåŸŸå†…
        if (!target.contains(e.relatedTarget)) {
          target.classList.remove('drag-over');
        }
      }

      function handleDrop(e, type, target) {
        e.preventDefault();
        e.stopPropagation();
        target.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          // æ£€æŸ¥æ–‡ä»¶ç±»å‹æ˜¯å¦åŒ¹é… (å›¾ç‰‡/è§†é¢‘/éŸ³é¢‘)
          const isImage = file.type.startsWith('image/');
          // ä¿®å¤ç‚¹ 2: å¢åŠ å¯¹ .mkv æ‰©å±•åçš„æ£€æŸ¥ï¼Œå°†å…¶è¯†åˆ«ä¸ºè§†é¢‘
          const isVideo = file.type.startsWith('video/') || file.name.toLowerCase().endsWith('.mkv');
          const isAudio = file.type.startsWith('audio/');

          if (type === 'bg' && (isImage || isVideo)) {
            handleDraggedFile(file, 'bg');
          } else if (type === 'bgm' && isAudio) {
            handleDraggedFile(file, 'bgm');
          } else {
            alert(`æ‹–å…¥çš„æ–‡ä»¶ç±»å‹ä¸ ${type === 'bg' ? 'èƒŒæ™¯ï¼ˆå›¾ç‰‡/è§†é¢‘/MKVï¼‰' : 'èƒŒæ™¯éŸ³ä¹ï¼ˆéŸ³é¢‘ï¼‰'} ä¸åŒ¹é…ã€‚`);
          }
        }
      }

      function handleDraggedFile(file, k) {
        const s = project.scripts[curIdx];

        // ä¿®å¤ï¼šå¢åŠ å¯¹ .mkv æ‰©å±•åçš„æ£€æŸ¥ï¼Œç¡®ä¿å…¶è¢«è¯†åˆ«ä¸ºè§†é¢‘
        const isImage = file.type.startsWith('image/');
        const isVideo = file.type.startsWith('video/') || file.name.toLowerCase().endsWith('.mkv');
        const isAudio = file.type.startsWith('audio/');

        if (isImage) {
          const r = new FileReader();
          r.onload = e => {
            s[k + 'Src'] = e.target.result;
            s[k + 'Type'] = 'image';
            saveData(); // saveDataä¼šè§¦å‘ renderGame å’Œ updateMediaï¼Œå®Œæˆé€‚é…
          };
          r.readAsDataURL(file);
        } else if (isVideo || isAudio) {
          // è§†é¢‘æˆ–éŸ³é¢‘ï¼Œè¿›å…¥å‰ªè¾‘æ¨¡å¼
          const mediaType = isVideo ? 'video' : 'audio';

          // ä¿®å¤ï¼šå¦‚æœæ˜¯MKVæ ¼å¼ï¼Œæå‰è­¦å‘Šç”¨æˆ·å¯èƒ½ä¸æ”¯æŒ
          if (isVideo && file.name.toLowerCase().endsWith('.mkv')) {
            const confirmMsg =
              'æ£€æµ‹åˆ°MKVæ ¼å¼è§†é¢‘ã€‚\n\næ³¨æ„ï¼šå¤§å¤šæ•°æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariç­‰ï¼‰åŸç”Ÿä¸æ”¯æŒMKVæ ¼å¼æ’­æ”¾ã€‚\n\nå¦‚æœæ— æ³•æ’­æ”¾ï¼Œè¯·å°†è§†é¢‘è½¬æ¢ä¸ºMP4ï¼ˆH.264ç¼–ç ï¼‰æˆ–WebMæ ¼å¼ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ';
            if (!confirm(confirmMsg)) {
              return;
            }
          }

          trim = {
            active: true,
            file: file,
            type: k,
            media: mediaType,
            s: 0,
            e: null,
          };
          openTrim();
        } else {
          alert(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}ã€‚è¯·æ‹–å…¥å›¾ç‰‡ã€è§†é¢‘ï¼ˆåŒ…æ‹¬MKVï¼‰æˆ–éŸ³é¢‘æ–‡ä»¶ã€‚`);
        }
      }
      /* --- æ‹–æ”¾é€»è¾‘ç»“æŸ --- */

      function handleDragStart(e, i) {
        dragSrcIdx = i;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.innerHTML);
        e.target.classList.add('dragging');
      }
      function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        return false;
      }
      function handleDragEnter(e) {
        e.target.closest('.flow-node')?.classList.add('drag-over');
      }
      function handleDragLeave(e) {
        e.target.closest('.flow-node')?.classList.remove('drag-over');
      }
      function handleDrop(e, i) {
        e.stopPropagation();
        e.target.closest('.flow-node')?.classList.remove('drag-over');
        document.querySelectorAll('.flow-node').forEach(el => el.classList.remove('dragging'));
        if (dragSrcIdx !== i && dragSrcIdx !== -1) {
          const list = project.scripts;
          const item = list.splice(dragSrcIdx, 1)[0];
          list.splice(i, 0, item);
          if (curIdx === dragSrcIdx) curIdx = i;
          else if (curIdx > dragSrcIdx && curIdx <= i) curIdx--;
          else if (curIdx < dragSrcIdx && curIdx >= i) curIdx++;
          renderFlowchart();
          renderGame(curIdx);
        }
        return false;
      }

      function renderGame(idx, isJump = false, affChange = 0, affRole = '') {
        if (idx < 0 || idx >= project.scripts.length) return;
        if (isJump && affChange !== 0) showAffinityFeedback(affRole, affChange);

        const prevS = project.scripts[curIdx];
        curIdx = idx;
        const s = project.scripts[idx];
        const r = project.roles[s.roleId] || { name: '???', color: '#fff', src: '', dialogueStyle: 'default' };

        const box = document.getElementById('dialogue-box');
        box.className = 'dialogue-box style-' + (r.dialogueStyle || 'default');

        const nameTag = document.getElementById('ui-name');
        nameTag.innerText = r.name === 'æ—ç™½' ? '' : r.name;
        if (r.dialogueStyle !== 'tech' && r.dialogueStyle !== 'sweet' && r.dialogueStyle !== 'retro') {
          nameTag.style.background = r.name === 'æ—ç™½' ? 'transparent' : r.color || 'var(--soft-purple)';
          nameTag.style.padding = r.name === 'æ—ç™½' ? '0' : '4px 18px';
        } else {
          nameTag.style.background = '';
          nameTag.style.padding = '';
        }

        startTypewriter(s.text);

        const charImg = document.getElementById('char-img');
        charImg.classList.remove('char-enter-anim');
        const shouldShow = r.src && r.src !== '' && s.charVisible !== false;

        if (shouldShow) {
          const wasHidden = charImg.classList.contains('hidden');
          const prevHidden = !project.roles[prevS.roleId]?.src || prevS.charVisible === false;
          charImg.src = r.src;
          const tx = s.charX || 0;
          const ty = s.charY || 0;
          const scale = s.charScale || 1.0;
          const opacity = s.charOpacity || 1.0;
          charImg.style.setProperty('--tx', tx + 'px');
          charImg.style.setProperty('--ty', ty + 'px');
          charImg.style.setProperty('--scale', scale);
          charImg.style.setProperty('--opacity', opacity);
          charImg.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
          charImg.style.opacity = opacity;
          charImg.classList.remove('hidden');
          if (wasHidden || prevHidden) {
            void charImg.offsetWidth;
            charImg.classList.add('char-enter-anim');
          }
        } else {
          charImg.classList.add('hidden');
        }

        updateMedia(idx, 'bg');
        updateMedia(idx, 'bgm');
        renderOpts(s);
        if (document.getElementById('tab-editor').classList.contains('active')) refreshEdit();
      }

      function startTypewriter(text) {
        const el = document.getElementById('ui-text');
        clearTimeout(typewriter.timer);
        typewriter.fullText = text;
        if (project.globalSpeed <= 0) {
          el.innerText = text;
          typewriter.isTyping = false;
          return;
        }
        typewriter.isTyping = true;
        el.innerText = '';
        let i = 0;
        function type() {
          if (i < text.length) {
            el.innerText += text.charAt(i);
            i++;
            typewriter.timer = setTimeout(type, project.globalSpeed);
          } else {
            typewriter.isTyping = false;
          }
        }
        type();
      }

      function finishTypewriter() {
        clearTimeout(typewriter.timer);
        document.getElementById('ui-text').innerText = typewriter.fullText;
        typewriter.isTyping = false;
      }

      function updateGlobalSpeed(val) {
        project.globalSpeed = parseInt(val);
        updateGlobalSpeedUI();
      }
      function updateGlobalSpeedUI() {
        const v = project.globalSpeed;
        const lbl = document.getElementById('val-global-speed');
        document.getElementById('inp-global-speed').value = v;
        if (v === 0) lbl.innerText = 'ç›´æ¥';
        else if (v <= 30) lbl.innerText = 'æå¿«';
        else if (v <= 60) lbl.innerText = 'ä¸­é€Ÿ';
        else lbl.innerText = 'æ…¢é€Ÿ';
      }

      function renderFlowchart() {
        const l = document.getElementById('flowchart-container');
        l.innerHTML = '';
        project.scripts.forEach((s, i) => {
          const r = project.roles[s.roleId] || { name: '???', color: '#999' };
          const d = document.createElement('div');
          d.className = `flow-node ${i === curIdx ? 'active' : ''}`;
          if (s._isNew) {
            d.classList.add('flash-anim');
            delete s._isNew;
          }
          d.draggable = true;
          d.ondragstart = e => handleDragStart(e, i);
          d.ondragover = handleDragOver;
          d.ondragenter = handleDragEnter;
          d.ondragleave = handleDragLeave;
          d.ondrop = e => handleDrop(e, i);
          d.onclick = e => {
            e.stopPropagation();
            renderGame(i);
          };
          d.innerHTML = `<div class="drag-handle">â˜°</div><div class="flow-idx">${
            i + 1
          }</div><div class="flow-role" style="background:${r.color || '#999'}">${r.name}</div><div class="flow-text">${
            s.text || '...'
          }</div>${
            s.next || s.opts.length
              ? '<div style="width:8px;height:8px;border-radius:50%;background:var(--accent-color)"></div>'
              : ''
          }<button class="flow-del" onclick="delS(${i},event)">Ã—</button>`;
          l.appendChild(d);
        });
      }

      function addNewScene() {
        const insertIdx = curIdx + 1;
        const newScene = {
          roleId: 'npc_1',
          text: '...',
          charScale: 1,
          charOpacity: 1,
          charX: 0,
          charY: 0,
          charVisible: true,
          bgType: 'inherit',
          bgMuted: true,
          bgVol: 1,
          bgmType: 'inherit',
          bgmVol: 1,
          next: null,
          opts: [],
          _isNew: true,
        };
        project.scripts.splice(insertIdx, 0, newScene);
        renderGame(insertIdx);
      }
      function delS(i, e) {
        e.stopPropagation();
        if (project.scripts.length > 1) {
          project.scripts.splice(i, 1);
          renderGame(Math.max(0, curIdx - 1));
          renderFlowchart();
        }
      }

      function refreshEdit() {
        const s = project.scripts[curIdx];
        document.getElementById('editor-idx').innerText = `è¡Œ ${curIdx + 1} / ${project.scripts.length}`;
        const sel = document.getElementById('inp-role-id');
        sel.innerHTML = '<option value="narrator">æ—ç™½</option>';
        Object.values(project.roles).forEach(r => {
          if (r.id !== 'narrator') sel.innerHTML += `<option value="${r.id}">${r.name}</option>`;
        });
        sel.value = s.roleId || 'narrator';
        document.getElementById('inp-text').value = s.text;
        document.getElementById('inp-next').value = s.next || '';
        document.getElementById('inp-bg-type').value = s.bgType;
        document.getElementById('inp-bgm-type').value = s.bgmType;

        document.getElementById('inp-video-vol').value = s.bgVol !== undefined ? s.bgVol : 1;
        document.getElementById('inp-bgm-vol').value = s.bgmVol !== undefined ? s.bgmVol : 1;

        const hasSprite = project.roles[s.roleId] && project.roles[s.roleId].src;
        document.getElementById('inp-char-visible').checked = s.charVisible !== false;
        document.getElementById('inp-char-visible').disabled = !hasSprite;

        document.getElementById('video-control').style.display = s.bgType === 'video' ? 'block' : 'none';
        document.getElementById('bgm-control').style.display = s.bgmType === 'file' ? 'block' : 'none';
        document.getElementById('inp-video-mute').checked = s.bgMuted !== false;
        updateMuteText();

        document.getElementById('inp-scale').value = s.charScale || 1.0;
        document.getElementById('val-scale').innerText = (s.charScale || 1.0).toFixed(1);
        document.getElementById('inp-opacity').value = s.charOpacity || 1.0;
        document.getElementById('val-opacity').innerText = (s.charOpacity || 1.0).toFixed(1);
        document.getElementById('inp-x').value = s.charX || 0;
        document.getElementById('val-x').innerText = s.charX || 0;
        document.getElementById('inp-y').value = s.charY || 0;
        document.getElementById('val-y').innerText = s.charY || 0;

        toggleMedia();
        renderFlowchart();
        renderOptList();
      }

      function saveData() {
        const s = project.scripts[curIdx];
        s.roleId = document.getElementById('inp-role-id').value;
        s.text = document.getElementById('inp-text').value;
        s.next = document.getElementById('inp-next').value;
        s.bgType = document.getElementById('inp-bg-type').value;
        s.bgmType = document.getElementById('inp-bgm-type').value;
        s.charScale = parseFloat(document.getElementById('inp-scale').value);
        s.charOpacity = parseFloat(document.getElementById('inp-opacity').value);
        s.charX = parseInt(document.getElementById('inp-x').value);
        s.charY = parseInt(document.getElementById('inp-y').value);
        s.charVisible = document.getElementById('inp-char-visible').checked;
        s.bgMuted = s.bgType === 'video' ? document.getElementById('inp-video-mute').checked : true;
        s.bgVol = parseFloat(document.getElementById('inp-video-vol').value);
        s.bgmVol = parseFloat(document.getElementById('inp-bgm-vol').value);
        renderGame(curIdx);
      }

      function updateVolume(type, val) {
        const v = parseFloat(val);
        if (type === 'bg') {
          const vid = document.getElementById('bg-layer-video');
          vid.volume = v;
        } else {
          const aud = document.getElementById('bgm-player');
          aud.volume = v;
        }
      }

      function applyToAllSameRole() {
        const currentScript = project.scripts[curIdx];
        const currentRole = currentScript.roleId;
        if (!currentRole || currentRole === 'narrator') return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆè§’è‰²');
        if (
          confirm(`ç¡®å®šè¦æŠŠå½“å‰çš„ç«‹ç»˜ä½ç½®ã€å¤§å°è®¾ç½®åº”ç”¨åˆ°å‰§æœ¬ä¸­æ‰€æœ‰ "${project.roles[currentRole].name}" çš„å°è¯è¡Œå—ï¼Ÿ`)
        ) {
          project.scripts.forEach(s => {
            if (s.roleId === currentRole) {
              s.charX = currentScript.charX;
              s.charY = currentScript.charY;
              s.charScale = currentScript.charScale;
              s.charOpacity = currentScript.charOpacity;
            }
          });
          alert('åº”ç”¨å®Œæˆï¼');
          renderGame(curIdx);
        }
      }

      function showAffinityFeedback(roleId, amount) {
        const el = document.getElementById('affinity-feedback');
        const role = project.roles[roleId] || { name: 'æœªçŸ¥' };
        el.classList.remove('aff-active');
        el.innerHTML =
          amount > 0
            ? `<span style="color:#ff7675">ğŸ’— ${role.name} +${amount}</span>`
            : `<span style="color:#636e72">ğŸ’” ${role.name} ${amount}</span>`;
        void el.offsetWidth;
        el.classList.add('aff-active');
      }

      /* æ ¸å¿ƒä¿®å¤ 2ï¼šåŠ¨æ€åˆ¤æ–­åª’ä½“æ¯”ä¾‹å¹¶è®¾ç½® object-fit */
      function applyMediaFit(mediaElement) {
        const isVideo = mediaElement.tagName === 'VIDEO';
        let ratio;

        if (isVideo) {
          // è§†é¢‘ï¼šä½¿ç”¨è§†é¢‘çš„å…ƒæ•°æ®å®½é«˜
          ratio = mediaElement.videoWidth / mediaElement.videoHeight;
        } else {
          // å›¾ç‰‡ï¼šä½¿ç”¨å›¾ç‰‡çš„è‡ªç„¶å®½é«˜
          ratio = mediaElement.naturalWidth / mediaElement.naturalHeight;
        }

        // èˆå°æ¯”ä¾‹ STAGE_RATIO = 1280 / 720 â‰ˆ 1.777
        // å¦‚æœåª’ä½“çš„æ¯”ä¾‹å°äºèˆå°æ¯”ä¾‹ï¼Œè¯´æ˜æ˜¯**ç«–å±**ï¼ˆé«˜å¤§äºå®½ç›¸å¯¹èˆå°ï¼‰æˆ–æ¥è¿‘æ­£æ–¹å½¢ï¼Œéœ€è¦ contain
        if (ratio < STAGE_RATIO) {
          mediaElement.style.objectFit = 'contain'; // å®Œæ•´æ˜¾ç¤ºï¼Œä¸¤ä¾§ç•™é»‘
        } else {
          mediaElement.style.objectFit = 'cover'; // é“ºæ»¡èˆå°ï¼Œå¯èƒ½æœ‰è£å‰ª
        }
      }

      function updateMedia(idx, k) {
        let d = null;
        for (let i = idx; i >= 0; i--)
          if (project.scripts[i][k + 'Type'] !== 'inherit') {
            d = project.scripts[i];
            break;
          }

        const img = document.getElementById('bg-layer-img');
        const vid = document.getElementById('bg-layer-video');
        const aud = document.getElementById('bgm-player');

        if (!d || d[k + 'Type'] === 'stop' || (k === 'bg' && d.bgType === 'image' && !d.bgSrc)) {
          if (k === 'bgm') {
            aud.pause();
            aud.src = '';
          }
          if (k === 'bg') {
            vid.classList.add('hidden');
            vid.pause();
            vid.src = '';
            img.classList.remove('hidden');
            img.src = '';
            if (d && d.bgSrc) applyMediaFit(img);
          } // å¦‚æœæœ‰ç»§æ‰¿æ¥çš„èƒŒæ™¯å›¾ï¼Œä¹Ÿè¦æ£€æŸ¥
          return;
        }

        const p = k === 'bg' ? vid : aud;
        const type = d[k + 'Type'];

        if (k === 'bg') {
          if (type === 'image') {
            vid.classList.add('hidden');
            vid.pause();
            img.classList.remove('hidden');
            if (img.src !== d.bgSrc) {
              img.src = d.bgSrc;
              img.onload = () => applyMediaFit(img); // å›¾ç‰‡åŠ è½½å®Œæˆååˆ¤æ–­æ¯”ä¾‹
            } else {
              applyMediaFit(img); // ç›¸åŒå›¾ç‰‡ä¹Ÿè¦ç¡®ä¿ objectFit æ­£ç¡®
            }
          } else if (type === 'video') {
            img.classList.add('hidden');
            vid.classList.remove('hidden');
            vid.muted = d.bgMuted !== false;
            if (!vid.muted) vid.volume = d.bgVol !== undefined ? d.bgVol : 1;

            if (vid.src !== d.bgSrc) {
              vid.src = d.bgSrc;
              vid.load(); // å¼ºåˆ¶é‡æ–°åŠ è½½ä»¥è§¦å‘ metadata
            }
          }
        }

        if (k === 'bgm' || (k === 'bg' && type === 'video')) {
          const srcKey = k + 'Src';

          if (p.src !== d[srcKey]) {
            p.src = d[srcKey];
            p.currentTime = d[k + 'S'] || 0;
            p.load();
          }

          const end = d[k + 'E'];
          const start = d[k + 'S'] || 0;
          p.ontimeupdate = end
            ? () => {
                if (p.currentTime >= end) p.currentTime = start;
              }
            : null;
          if (!end) p.loop = true;

          if (k === 'bg' && type === 'video') {
            // è§†é¢‘åŠ è½½å…ƒæ•°æ®ååˆ¤æ–­æ¯”ä¾‹
            p.onloadedmetadata = () => {
              applyMediaFit(p);
              // ä¿®å¤ï¼šæ£€æŸ¥è§†é¢‘æ˜¯å¦çœŸçš„å¯ä»¥æ’­æ”¾
              if (p.readyState < 2) {
                console.warn('è§†é¢‘å¯èƒ½æ ¼å¼ä¸æ”¯æŒï¼ŒreadyState:', p.readyState);
              }
            };

            // ä¿®å¤ï¼šæ·»åŠ é¢å¤–çš„é”™è¯¯æ£€æŸ¥
            p.oncanplay = () => {
              console.log('è§†é¢‘å¯ä»¥æ’­æ”¾');
            };

            p.oncanplaythrough = () => {
              console.log('è§†é¢‘å¯ä»¥æµç•…æ’­æ”¾');
            };
          }

          const attemptPlay = () => {
            p.play().catch(e => {
              console.warn('Autoplay blocked, retrying muted...', e);
              if (!p.muted) {
                p.muted = true;
                p.play().catch(e2 => {
                  console.error('Play failed', e2);
                  // ä¿®å¤ï¼šå¦‚æœé™éŸ³åä»ç„¶æ— æ³•æ’­æ”¾ï¼Œå¯èƒ½æ˜¯æ ¼å¼ä¸æ”¯æŒ
                  if (k === 'bg' && type === 'video') {
                    alert('è§†é¢‘æ— æ³•æ’­æ”¾ã€‚å¯èƒ½æ˜¯æ ¼å¼ä¸æ”¯æŒï¼ˆå¦‚MKVï¼‰ï¼Œè¯·å°è¯•è½¬æ¢ä¸ºMP4ï¼ˆH.264ç¼–ç ï¼‰æˆ–WebMæ ¼å¼ã€‚');
                  }
                });
              }
            });
            const targetVol = k === 'bgm' ? (d.bgmVol !== undefined ? d.bgmVol : 1) : 1;
            if (k === 'bgm' && p.volume === 0) fadeIn(p, targetVol);
            if (k === 'bgm' && p.volume > 0) p.volume = targetVol;
          };
          attemptPlay();
        }
      }

      function fadeIn(a, target) {
        let v = 0;
        a.volume = 0;
        const i = setInterval(() => {
          v += 0.05;
          if (v >= target) {
            v = target;
            clearInterval(i);
          }
          a.volume = v;
        }, 50);
      }

      function toggleLayer(id, btn) {
        const el = document.getElementById(id);
        el.classList.toggle('hidden');
        btn.classList.toggle('off');
        if (id === 'ui-layer' && el.classList.contains('hidden'))
          document.getElementById('hud-controls').classList.add('hidden');
      }
      function updateMuteText() {
        const m = document.getElementById('inp-video-mute').checked;
        document.getElementById('mute-status-text').innerText = m ? 'ğŸ”‡ é™éŸ³' : 'ğŸ”Š åŸå£°';
      }
      function updateSlider(k, v) {
        document.getElementById('val-' + k).innerText =
          k === 'scale' || k === 'opacity' ? parseFloat(v).toFixed(1) : parseInt(v);
      }

      function renderPalette() {
        const p = document.getElementById('color-palette');
        p.innerHTML = '';
        COLORS.forEach(c => {
          const d = document.createElement('div');
          d.className = 'color-swatch';
          d.style.backgroundColor = c;
          d.onclick = () => {
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
            d.classList.add('selected');
            document.getElementById('new-role-color').value = c;
          };
          p.appendChild(d);
        });
        p.children[0].click();
      }

      function createRole() {
        const n = document.getElementById('new-role-name').value,
          c = document.getElementById('new-role-color').value,
          s = document.getElementById('new-role-style').value,
          f = document.getElementById('new-role-img').files[0];
        if (!n) return alert('è¯·è¾“å…¥åå­—');
        const id = 'r_' + Date.now();
        const finish = src => {
          project.roles[id] = { id, name: n, color: c, src, affinity: 0, dialogueStyle: s };
          renderCharGrid();
          refreshEdit();
        };
        if (f) {
          const r = new FileReader();
          r.onload = e => finish(e.target.result);
          r.readAsDataURL(f);
        } else finish('');
      }
      function renderCharGrid() {
        const g = document.getElementById('char-grid');
        g.innerHTML = '';
        Object.values(project.roles).forEach(r => {
          if (r.id === 'narrator') return;
          const d = document.createElement('div');
          d.className = 'char-card';
          d.style.borderColor = r.color;
          d.innerHTML = `<img src="${r.src}" onerror="this.style.opacity=0.3" style="border-color:${r.color}"><div style="font-weight:bold;margin-top:5px;">${r.name}</div><div style="font-size:12px;color:#888">${r.dialogueStyle}</div><div class="aff-val">ğŸ’“ ${r.affinity}</div><button class="btn btn-danger" onclick="delRole('${r.id}')" style="margin-top:10px;padding:5px 10px;font-size:12px;">åˆ é™¤</button>`;
          g.appendChild(d);
        });
      }
      function delRole(id) {
        if (confirm('ç¡®å®šåˆ é™¤?')) {
          delete project.roles[id];
          renderCharGrid();
          refreshEdit();
        }
      }
      function resetAff() {
        if (confirm('é‡ç½®å¥½æ„Ÿåº¦?')) {
          Object.keys(project.roles).forEach(k => (project.roles[k].affinity = 0));
          renderCharGrid();
        }
      }

      function renderOptList() {
        const l = document.getElementById('opt-list');
        l.innerHTML = '';
        project.scripts[curIdx].opts.forEach((o, i) => {
          const d = document.createElement('div');
          d.className = 'opt-row';
          let ro = "<option value=''>æ— å˜åŒ–</option>";
          Object.values(project.roles).forEach(r => {
            if (r.id !== 'narrator')
              ro += `<option value="${r.id}" ${o.role === r.role ? 'selected' : ''}>${r.name}</option>`;
          });
          d.innerHTML = `
                    <input value="${o.text}" onchange="updO(${i},'text',this.value)" style="flex:1 0 100%; margin-bottom: 8px;" placeholder="é€‰é¡¹å†…å®¹">
                    <span class="opt-label">è·³è½¬è‡³</span>
                    <input type="number" value="${o.next}" onchange="updO(${i},'next',this.value)" style="width:90px">
                    <span class="opt-label" style="margin-left:15px;">å¥½æ„Ÿè§’è‰²</span>
                    <select onchange="updO(${i},'role',this.value)" style="width:100px">${ro}</select>
                    <input type="number" value="${o.val}" onchange="updO(${i},'val',this.value)" style="width:60px">
                    <button class="btn btn-danger" onclick="delO(${i})" style="width:30px;padding:0;margin-left:auto;">Ã—</button>
                `;
          l.appendChild(d);
        });
      }
      function addOpt() {
        project.scripts[curIdx].opts.push({ text: 'é€‰é¡¹', next: curIdx + 1, role: '', val: 0 });
        refreshEdit();
        renderFlowchart();
      }
      function updO(i, k, v) {
        project.scripts[curIdx].opts[i][k] = v;
        renderGame(curIdx);
        renderFlowchart();
      }
      function delO(i) {
        project.scripts[curIdx].opts.splice(i, 1);
        refreshEdit();
        renderFlowchart();
      }

      function renderOpts(s) {
        const l = document.getElementById('choice-layer');
        l.innerHTML = '';
        if (s.opts && s.opts.length > 0) {
          l.classList.remove('hidden');
          document.getElementById('ui-layer').style.opacity = 0.3;
          s.opts.forEach(o => {
            const b = document.createElement('button');
            b.innerText = o.text;
            b.style =
              'padding:15px 50px;font-size:20px;font-weight:bold;cursor:pointer;background:rgba(255,255,255,0.95);border:2px solid white;border-radius:16px;box-shadow:0 5px 15px rgba(0,0,0,0.1);min-width:600px;color:#333;transition:0.2s;';
            b.onmouseover = () => (b.style.transform = 'scale(1.05)');
            b.onmouseout = () => (b.style.transform = 'scale(1)');
            b.onclick = e => {
              e.stopPropagation();
              let nextIdx = parseInt(o.next) - 1;
              if (isNaN(nextIdx)) nextIdx = curIdx + 1;

              if (o.role && project.roles[o.role] && o.val != 0) {
                project.roles[o.role].affinity += parseInt(o.val);
                renderGame(nextIdx, true, parseInt(o.val), o.role);
                renderCharGrid();
              } else renderGame(nextIdx);
            };
            l.appendChild(b);
          });
        } else {
          l.classList.add('hidden');
          document.getElementById('ui-layer').style.opacity = 1;
        }
      }
      function gameNext() {
        const s = project.scripts[curIdx];
        if (!s.opts.length) {
          const n = s.next ? parseInt(s.next) - 1 : curIdx + 1;
          if (n < project.scripts.length) renderGame(n);
        }
      }

      function toggleMedia() {
        const bt = document.getElementById('inp-bg-type').value,
          mt = document.getElementById('inp-bgm-type').value;
        document.getElementById('btn-up-bg').style.display = bt === 'image' || bt === 'video' ? 'block' : 'none';
        document.getElementById('btn-up-bgm').style.display = mt === 'file' ? 'block' : 'none';
        document.getElementById('video-control').style.display = bt === 'video' ? 'block' : 'none';
        document.getElementById('bgm-control').style.display = mt === 'file' ? 'block' : 'none';
      }

      function trigUp(k) {
        const t = document.getElementById('inp-' + k + '-type').value,
          i = document.getElementById('file-' + k);
        // ä¿®å¤ç‚¹ 4: åœ¨æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†ä¸­å…è®¸ .mkv æ ¼å¼
        i.accept = k === 'bg' && t === 'image' ? 'image/*' : t === 'video' ? 'video/*,.mkv' : 'audio/*';
        i.click();
      }

      function handleFile(inp, k) {
        // å…¼å®¹ç‚¹å‡»ä¸Šä¼ çš„æ–‡ä»¶å¤„ç†
        const f = inp.files[0];
        if (!f) return;

        // ä¿®å¤ï¼šç¡®ä¿MKVæ–‡ä»¶è¢«æ­£ç¡®è¯†åˆ«
        // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯è§†é¢‘ç±»å‹ï¼Œä½†æ–‡ä»¶æ˜¯MKVï¼ˆå¯èƒ½MIMEç±»å‹ä¸æ­£ç¡®ï¼‰ï¼Œéœ€è¦ç¡®ä¿è¢«è¯†åˆ«ä¸ºè§†é¢‘
        const isVideo = f.type.startsWith('video/') || f.name.toLowerCase().endsWith('.mkv');
        const isImage = f.type.startsWith('image/');
        const isAudio = f.type.startsWith('audio/');

        // æ ¹æ®å½“å‰é€‰æ‹©çš„ç±»å‹å’Œæ–‡ä»¶ç±»å‹è¿›è¡ŒéªŒè¯
        const currentType = document.getElementById('inp-' + k + '-type').value;

        if (k === 'bg') {
          if (currentType === 'image' && !isImage) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            inp.value = '';
            return;
          }
          if (currentType === 'video' && !isVideo) {
            alert('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼ˆåŒ…æ‹¬MKVæ ¼å¼ï¼‰');
            inp.value = '';
            return;
          }
        } else if (k === 'bgm') {
          if (currentType === 'file' && !isAudio) {
            alert('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
            inp.value = '';
            return;
          }
        }

        handleDraggedFile(f, k);
        inp.value = '';
      }

      function openTrim() {
        const c = document.getElementById('trim-preview');
        c.innerHTML = '';
        const url = URL.createObjectURL(trim.file);
        trim.player = document.createElement(trim.media === 'video' ? 'video' : 'audio');
        trim.player.src = url;
        trim.player.controls = true;
        trim.player.style.width = '100%';
        trim.player.style.height = '100%';
        trim.player.style.objectFit = 'contain';
        trim.player.onloadedmetadata = () => {
          document.getElementById('t-end').innerText = trim.player.duration.toFixed(2);
        };
        c.appendChild(trim.player);
        document.getElementById('trimmer-modal').style.display = 'flex';
      }
      function setTrim(p) {
        const t = trim.player.currentTime;
        if (p === 's') {
          trim.s = t;
          document.getElementById('t-start').innerText = t.toFixed(2);
        } else {
          trim.e = t;
          document.getElementById('t-end').innerText = t.toFixed(2);
        }
      }
      function closeTrim() {
        document.getElementById('trimmer-modal').style.display = 'none';
        trim.player.pause();
        URL.revokeObjectURL(trim.player.src);
      }
      function confirmTrim() {
        const r = new FileReader();
        r.onload = e => {
          const s = project.scripts[curIdx];
          s[trim.type + 'Src'] = e.target.result;
          s[trim.type + 'Type'] = trim.media === 'video' ? 'video' : 'file';
          s[trim.type + 'S'] = trim.s;
          s[trim.type + 'E'] = trim.e;
          if (trim.media === 'video') s.bgMuted = s.bgMuted === undefined ? true : s.bgMuted;
          closeTrim();
          renderGame(curIdx);
        };
        r.readAsDataURL(trim.file);
      }

      function toggleFS() {
        const e = document.getElementById('stage-wrapper');
        if (!document.fullscreenElement) e.requestFullscreen().catch(() => {});
        else document.exitFullscreen();
      }
      function exportProj() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(project)], { type: 'application/json' }));
        a.download = 'gal_project_v2.4.json';
        a.click();
      }
      function importProj(i) {
        const r = new FileReader();
        r.onload = e => {
          try {
            const imported = JSON.parse(e.target.result);
            if (imported.scripts)
              imported.scripts.forEach(s => {
                if (s.charX === undefined) s.charX = 0;
                if (s.charY === undefined) s.charY = 0;
                if (s.dialogueStyle === undefined) s.dialogueStyle = 'default';
              });
            if (imported.roles)
              Object.values(imported.roles).forEach(r => {
                if (r.dialogueStyle === undefined) r.dialogueStyle = 'default';
              });
            project = imported;
            updateGlobalSpeedUI();
            renderGame(0);
            refreshEdit();
            alert('å¯¼å…¥æˆåŠŸï¼');
          } catch (x) {
            alert('æ–‡ä»¶æ— æ•ˆ');
          }
        };
        if (i.files[0]) r.readAsText(i.files[0]);
      }
      function switchTab(t) {
        document.querySelectorAll('.main-content').forEach(e => e.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if (t === 'editor') refreshEdit();
        else renderCharGrid();
      }
    </script>
  </body>
</html>
