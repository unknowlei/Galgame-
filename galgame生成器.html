<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galgame ç”Ÿæˆå™¨ V1.1 - æ‹–æ‹½æ’åºç‰ˆ</title>
    <style>
        /* --- å…¨å±€ä¸»é¢˜ (æ¸…æ–°ç§‘æŠ€é£ V1.1) --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #f6f8fb 0%, #e2ebf0 100%);
            --accent-color: #74b9ff; /* å¤©ç©ºè“ */
            --soft-pink: #ff7675;    /* çŠç‘šçº¢ */
            --soft-purple: #a29bfe;  /* è–°è¡£è‰ */
            --text-main: #2d3436;
            --text-sub: #636e72;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.9);
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-float: 0 8px 24px rgba(116, 185, 255, 0.25);
            --rounding: 20px;
        }

        body {
            font-family: "Nunito", "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0;
            background: var(--bg-gradient); background-attachment: fixed;
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center;
            padding-bottom: 100px; user-select: none;
            /* ç§‘æŠ€æ„Ÿç½‘æ ¼èƒŒæ™¯ */
            background-image: radial-gradient(rgba(116, 185, 255, 0.15) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* --- 1. èˆå°åŒºåŸŸ --- */
        #stage-container {
            margin-top: 30px; padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.1);
            backdrop-filter: blur(10px);
        }

        #stage-wrapper {
            position: relative; width: 1280px; height: 720px;
            overflow: hidden; background: #000; border-radius: 16px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.1);
        }

        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; transition: opacity 0.3s; }
        .hidden { display: none !important; }

        /* ç«‹ç»˜å±‚ */
        #char-layer { z-index: 10; display: flex; align-items: flex-end; justify-content: flex-start; padding-left: 80px; height: 100%; }
        #char-img {
            max-height: 85%; max-width: 35%; object-fit: contain;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
            transform-origin: bottom center;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
        }
        .char-enter-anim { animation: slideInLeft 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes slideInLeft { from { transform: translateX(-30px) scale(var(--scale)); opacity: 0; } to { transform: translateX(0) scale(var(--scale)); opacity: var(--opacity); } }

        /* UIå±‚ (å¯¹è¯æ¡†) */
        #ui-layer { z-index: 20; }
        .dialogue-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 92%; height: 170px; /* ä¸­å¿ƒç‚¹è·åº•è¾¹ 30 + 85 = 115px */
            padding: 25px 35px; box-sizing: border-box;
            pointer-events: auto; cursor: pointer;
            display: flex; flex-direction: column; transition: all 0.3s;
        }
        
        /* å¯¹è¯æ¡†æ ·å¼ */
        .style-default { background: rgba(255,255,255,0.9); border-radius: 24px; border: 2px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); color: #444; backdrop-filter: blur(15px); }
        .style-default .name-tag { background: var(--soft-purple); color: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(162, 155, 254, 0.4); }
        
        .style-tech { background: rgba(16, 20, 30, 0.9); border: 2px solid #00cec9; border-radius: 8px; color: #00cec9; box-shadow: 0 0 15px rgba(0, 206, 201, 0.2); }
        .style-tech .name-tag { background: #00cec9; color: black; border-radius: 4px; }
        
        .style-sweet { background: #fff5f7; border: 3px dashed #ff7675; border-radius: 30px; color: #d63031; }
        .style-sweet .name-tag { background: #ff7675; color: white; border-radius: 50px; border: 2px solid white; }
        
        .style-retro { background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.9)); border: 2px solid #aaa; border-radius: 4px; color: #eee; }
        .style-retro .name-tag { color: #f1c40f; padding: 0; text-shadow: 1px 1px black; }

        .name-tag { font-size: 24px; font-weight: 800; margin-bottom: 10px; padding: 4px 18px; display: inline-block; width: fit-content; }
        .text-content { font-size: 22px; line-height: 1.6; font-weight: 600; }

        /* --- HUD å¼€å…³æŒ‰é’® (ä½ç½®ä¿®æ­£) --- */
        #hud-controls {
            position: absolute;
            /* æ ¸å¿ƒé€»è¾‘ï¼šå¯¹è¯æ¡†é«˜åº¦170ï¼Œbottom 30ã€‚ä¸­å¿ƒç‚¹åœ¨Y=115px */
            bottom: 115px; 
            right: 20px; /* æ”¾åœ¨å³ä¾§ï¼Œé¿å…é®æŒ¡å·¦ä¾§ç«‹ç»˜ */
            transform: translateY(50%); /* å‘ä¸‹åç§»è‡ªèº«çš„ä¸€åŠï¼Œå®ç°ä¸­å¿ƒå¯¹é½ */
            
            display: flex; flex-direction: column; gap: 12px;
            z-index: 100;
        }
        .hud-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255,255,255,0.6);
            color: white; font-size: 16px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .hud-btn:hover { background: var(--accent-color); transform: scale(1.15); border-color: white; }
        .hud-btn.off { background: var(--soft-pink); opacity: 0.8; text-decoration: line-through; }

        /* --- 2. ç¼–è¾‘å™¨ --- */
        .main-content { width: 1280px; margin-top: 25px; display: none; gap: 25px; }
        .main-content.active { display: grid; }
        .main-content.grid-2-flow { grid-template-columns: 360px 1fr; } /* å·¦ä¾§ç¨çª„ï¼Œå³ä¾§å®½ */

        .panel {
            background: var(--glass-bg); border: var(--glass-border);
            border-radius: var(--rounding); padding: 25px;
            box-shadow: var(--shadow-card); backdrop-filter: blur(20px);
            display: flex; flex-direction: column;
        }
        h2 {
            font-size: 18px; color: var(--text-main); margin: 0 0 20px 0;
            padding-left: 12px; border-left: 5px solid var(--accent-color);
            font-weight: 800; letter-spacing: 0.5px;
        }

        /* è¡¨å•æ§ä»¶ */
        label { font-size: 13px; font-weight: 700; color: var(--text-sub); margin: 15px 0 8px 0; display: block; }
        input, select, textarea {
            width: 100%; padding: 10px 15px; border-radius: 12px;
            border: 2px solid #e0e0e0; background: rgba(255,255,255,0.8);
            color: var(--text-main); font-family: inherit; font-size: 14px;
            box-sizing: border-box; transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-color); background: #fff; box-shadow: 0 0 0 4px rgba(116, 185, 255, 0.15); }
        
        .btn {
            padding: 10px 20px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer;
            background: white; color: var(--text-main); box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); color: var(--accent-color); }
        .btn-primary { background: var(--accent-color); color: white; width: 100%; }
        .btn-primary:hover { background: #5ca8ff; color: white; }
        .btn-danger { background: var(--soft-pink); color: white; }
        .btn-danger:hover { background: #ff6b6b; color: white; }

        /* é¢œè‰²é€‰æ‹© */
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; }
        .color-swatch {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            border: 2px solid rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .color-swatch:hover { transform: scale(1.2); }
        .color-swatch.selected { border-color: var(--text-main); transform: scale(1.1); }

        /* --- å‰§æœ¬æµè½¬å›¾ (ç¾åŒ– + æ‹–æ‹½) --- */
        #flowchart-panel { max-height: 70vh; }
        #flowchart-container { 
            flex-grow: 1; overflow-y: auto; padding: 5px; margin: -5px;
            scrollbar-width: thin;
        }
        
        .flow-node {
            background: white; 
            border-radius: 14px;
            border: 1px solid transparent;
            padding: 12px 15px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 10px;
            cursor: grab; /* æŠ“æ‰‹å…‰æ ‡ */
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            transition: all 0.2s ease;
            position: relative; overflow: hidden;
        }
        .flow-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(116, 185, 255, 0.15);
            border-color: rgba(116, 185, 255, 0.3);
        }
        .flow-node:active { cursor: grabbing; }
        .flow-node.active { 
            background: #f0f9ff; border: 1px solid var(--accent-color); 
        }
        .flow-node.dragging { opacity: 0.4; border: 2px dashed var(--accent-color); background: #f1f2f6; transform: scale(0.95); }

        /* èŠ‚ç‚¹å†…éƒ¨å…ƒç´  */
        .drag-handle { color: #ccc; font-size: 18px; cursor: grab; display: flex; align-items: center; }
        .flow-idx { 
            font-size: 12px; font-weight: 800; color: #b2bec3; 
            background: #f5f6fa; padding: 2px 6px; border-radius: 6px; min-width: 20px; text-align: center;
        }
        .flow-role { 
            font-size: 12px; font-weight: 700; color: white; padding: 3px 8px; border-radius: 20px; 
            max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .flow-text { flex: 1; font-size: 14px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .flow-del { 
            opacity: 0; color: #ff7675; background: transparent; border: none; font-size: 18px; cursor: pointer; padding: 0 5px; transition: 0.2s; 
        }
        .flow-node:hover .flow-del { opacity: 1; }
        .flow-del:hover { transform: scale(1.2); }

        /* é€‰é¡¹åˆ—è¡¨ç¾åŒ– */
        .opt-row { 
            background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #eee;
            display:flex; flex-wrap: wrap; gap:10px; align-items:center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .opt-label { font-size: 11px; color: #aaa; font-weight: 800; text-transform: uppercase; }

        /* åº•éƒ¨å¯¼èˆª */
        #bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            padding: 8px 10px; border-radius: 50px; display: flex; gap: 5px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.5);
            z-index: 900;
        }
        .nav-btn {
            background: transparent; color: var(--text-sub); border: none; padding: 10px 24px;
            cursor: pointer; border-radius: 30px; font-weight: 700; font-size: 15px; transition: 0.3s;
        }
        .nav-btn:hover { color: var(--accent-color); background: #f0f9ff; }
        .nav-btn.active { background: var(--text-main); color: white; box-shadow: 0 4px 12px rgba(45, 52, 54, 0.3); }

        /* å‰ªè¾‘å™¨ & æ»‘å— */
        #trimmer-modal .trim-content { background: white; padding: 30px; border-radius: 24px; width: 800px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        #trim-preview { background: #000; border-radius: 12px; height: 50vh; display: flex; justify-content: center; align-items: center; margin: 15px 0; }
        video, audio { max-height: 100%; max-width: 100%; }
        
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #dfe6e9; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <div id="stage-container">
        <div id="stage-wrapper">
            <div id="affinity-feedback" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:40px;font-weight:900;opacity:0;pointer-events:none;z-index:50;text-shadow:0 5px 20px rgba(0,0,0,0.2);"></div>
            <img id="bg-layer-img" class="layer">
            <video id="bg-layer-video" class="layer hidden" loop playsinline></video>
            <audio id="bgm-player" loop></audio>

            <div id="char-layer" class="layer"><img id="char-img" class="hidden"></div>
            <div id="choice-layer" class="layer hidden" style="background:rgba(255,255,255,0.4);backdrop-filter:blur(8px);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:15px;z-index:30;"></div>
            
            <div id="ui-layer" class="layer">
                <div class="dialogue-box style-default" id="dialogue-box" onclick="gameNext()">
                    <div class="name-tag" id="ui-name"></div>
                    <div class="text-content" id="ui-text"></div>
                </div>
            </div>

            <div id="hud-controls">
                <div class="hud-btn" onclick="toggleLayer('char-layer', this)" title="æ˜¾ç¤º/éšè—ç«‹ç»˜">ğŸ‘ï¸</div>
                <div class="hud-btn" onclick="toggleLayer('ui-layer', this)" title="æ˜¾ç¤º/éšè—å¯¹è¯æ¡†">ğŸ’¬</div>
            </div>

            <button onclick="toggleFS()" style="position:absolute;top:20px;right:20px;z-index:100;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.5);color:white;border-radius:12px;padding:6px 14px;backdrop-filter:blur(4px);cursor:pointer;font-weight:bold;">â›¶ å…¨å±</button>
        </div>
    </div>

    <div id="tab-editor" class="main-content grid-2-flow active">
        <div class="left-flow-column">
            <div id="flowchart-panel" class="panel">
                <h2>ğŸŒ³ å‰§æœ¬æµè½¬å›¾</h2>
                <div id="flowchart-container"></div>
                <button class="btn btn-primary" style="margin-top:15px;" onclick="addNewScene()">+ æ–°å¢å°è¯è¡Œ</button>
            </div>
            <div class="panel">
                <h2>ğŸ”€ é€»è¾‘ä¸è·³è½¬</h2>
                <label>â­ï¸ çº¿æ€§è·³è½¬è‡³ (è¡Œå·)</label>
                <input type="number" id="inp-next" min="1" placeholder="é»˜è®¤ä¸‹ä¸€è¡Œ" onchange="saveData()">
                <label>ğŸ’¡ åˆ†æ”¯é€‰é¡¹</label>
                <button class="btn" onclick="addOpt()" style="width:100%; margin-bottom:10px; border:1px dashed #ccc;">+ æ·»åŠ é€‰é¡¹</button>
                <div id="opt-list" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; border:none; padding:0;">âœï¸ å¯¼æ¼”æ§åˆ¶å°</h2>
                <span id="editor-idx" style="font-size:14px; font-weight:bold; color:var(--accent-color); background:#f0f9ff; padding:6px 12px; border-radius:8px;">è¡Œ 1</span>
            </div>
            
            <label>ğŸ—£ï¸ è¯´è¯è§’è‰²</label>
            <select id="inp-role-id" onchange="saveData()"></select>

            <div style="background:#f8f9fa; padding:15px; border-radius:15px; margin-top:15px; border:1px solid #eee;">
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:13px; font-weight:bold; color:#666; margin-bottom:10px;">
                    <span>ğŸ‘» ç«‹ç»˜æ§åˆ¶</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label for="inp-char-visible" style="margin:0; cursor:pointer;">æ˜¾ç¤º</label>
                        <label class="toggle-switch"><input type="checkbox" id="inp-char-visible" checked onchange="saveData()"><span class="slider"></span></label>
                    </div>
                </div>
                <div style="display:flex; gap:15px;">
                    <div style="flex:1;"><label style="margin:0 0 5px 0;">ç¼©æ”¾ <span id="val-scale" style="color:var(--accent-color)">1.0</span></label><input type="range" id="inp-scale" min="0.5" max="1.5" step="0.1" value="1.0" oninput="updateSlider('scale',this.value); saveData()"></div>
                    <div style="flex:1;"><label style="margin:0 0 5px 0;">é€æ˜ <span id="val-opacity" style="color:var(--accent-color)">1.0</span></label><input type="range" id="inp-opacity" min="0.1" max="1.0" step="0.1" value="1.0" oninput="updateSlider('opacity',this.value); saveData()"></div>
                </div>
            </div>

            <label>ğŸ’¬ å°è¯å†…å®¹</label>
            <textarea id="inp-text" rows="4" onchange="saveData()"></textarea>

            <label>ğŸ–¼ï¸ èƒŒæ™¯ç”»é¢</label>
            <div style="display:flex; gap:8px;">
                <select id="inp-bg-type" onchange="toggleMedia();saveData();" style="flex:1"><option value="inherit">â†ªï¸ ä¿æŒä¸å˜</option><option value="image">ğŸ–¼ï¸ å›¾ç‰‡</option><option value="video">ğŸ¥ è§†é¢‘</option></select>
                <button class="btn" id="btn-up-bg" onclick="trigUp('bg')" style="width:50px;">ğŸ“‚</button>
            </div>
            <div id="video-control" style="display:none; margin-top:10px; background:#e3f2fd; padding:10px; border-radius:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span id="mute-status-text" style="font-size:12px; color:#1565c0; font-weight:bold;">ğŸ”Š åŸå£°</span>
                    <label class="toggle-switch"><input type="checkbox" id="inp-video-mute" checked onchange="updateMuteText(); saveData()"><span class="slider"></span></label>
                </div>
            </div>

            <label>ğŸµ èƒŒæ™¯éŸ³ä¹</label>
            <div style="display:flex; gap:8px;">
                <select id="inp-bgm-type" onchange="toggleMedia();saveData();" style="flex:1"><option value="inherit">â†ªï¸ ä¿æŒä¸å˜</option><option value="file">ğŸµ æ’­æ”¾</option><option value="stop">ğŸ”‡ åœæ­¢</option></select>
                <button class="btn" id="btn-up-bgm" onclick="trigUp('bgm')" style="width:50px;">ğŸ“‚</button>
            </div>
            
            <input type="file" id="file-bg" class="hidden" accept="image/*,video/*" onchange="handleFile(this,'bg')">
            <input type="file" id="file-bgm" class="hidden" accept="audio/*" onchange="handleFile(this,'bgm')">
        </div>
    </div>

    <div id="tab-roles" class="main-content">
        <div class="panel" style="grid-column: 1 / -1;">
            <h2>ğŸ‘¥ æ¼”å‘˜æ‹›å‹Ÿ</h2>
            <div style="display:flex; gap:20px; background:white; padding:20px; border-radius:15px; border: 1px solid #eee; flex-wrap:wrap;">
                <div style="flex:1; min-width:150px;"><label style="margin-top:0;">å§“å</label><input type="text" id="new-role-name" placeholder="Role Name"></div>
                <div style="flex:1; min-width:150px;"><label style="margin-top:0;">å¯¹è¯æ¡†é£æ ¼</label><select id="new-role-style"><option value="default">ğŸ¬ æ¸…æ–°é»˜è®¤</option><option value="tech">ğŸ¤– èµ›åšç§‘æŠ€</option><option value="sweet">ğŸ­ ç”œèœœç³–æœ</option><option value="retro">ğŸ“œ ç»å…¸å¤å¤</option></select></div>
                <div style="flex:1; min-width:200px;"><label style="margin-top:0;">ä¸»é¢˜è‰²</label><div class="color-grid" id="color-palette"></div><input type="hidden" id="new-role-color" value="#ffffff"></div>
                <div style="flex:1; min-width:200px;"><label style="margin-top:0;">ç«‹ç»˜ (å¯é€‰)</label><input type="file" id="new-role-img" accept="image/*"></div>
                <div style="width:100%;"><button class="btn btn-primary" onclick="createRole()">+ åˆ›å»ºè§’è‰²</button></div>
            </div>
            <div id="char-grid" style="margin-top:30px; display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:20px;"></div>
            <button class="btn btn-danger" onclick="resetAff()" style="margin-top:30px; width:100%;">é‡ç½®æ‰€æœ‰å¥½æ„Ÿåº¦</button>
        </div>
    </div>

    <div id="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('editor')">ğŸ“ å‰§æœ¬</button>
        <button class="nav-btn" onclick="switchTab('roles')">ğŸ‘¥ è§’è‰²</button>
        <div style="width:1px; background:#ddd; margin:0 5px;"></div>
        <button class="nav-btn" onclick="exportProj()">ğŸ’¾ å¯¼å‡º</button>
        <button class="nav-btn" onclick="document.getElementById('imp-f').click()">ğŸ“‚ å¯¼å…¥</button>
        <input type="file" id="imp-f" class="hidden" accept=".json" onchange="importProj(this)">
    </div>

    <div id="trimmer-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px); z-index:2000; justify-content:center; align-items:center;">
        <div class="trim-content">
            <h3>âœ‚ï¸ åª’ä½“å‰ªè¾‘</h3>
            <div id="trim-preview"></div>
            <div style="margin:15px; font-family:monospace;">Start: <span id="t-start" style="color:var(--accent-color);font-weight:bold;">0.00</span>s | End: <span id="t-end" style="color:var(--accent-color);font-weight:bold;">--</span>s</div>
            <div style="display:flex; justify-content:center; gap:15px;"><button class="btn" onclick="setTrim('s')">ğŸ“ è®¾ä¸ºå¼€å§‹</button><button class="btn" onclick="setTrim('e')">ğŸ è®¾ä¸ºç»“æŸ</button></div>
            <div style="margin-top:25px; border-top:1px solid #eee; padding-top:20px; display:flex; justify-content:center; gap:15px;"><button class="btn" onclick="closeTrim()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="confirmTrim()">ç¡®è®¤</button></div>
        </div>
    </div>

    <script>
        const COLORS = ["#ff7675", "#fd79a8", "#e84393", "#fab1a0", "#ffeaa7", "#fdcb6e", "#e17055", "#00b894", "#00cec9", "#74b9ff", "#0984e3", "#6c5ce7", "#a29bfe", "#dfe6e9", "#636e72", "#2d3436"];
        let project = {
            roles: { 'narrator': { id: 'narrator', name: 'æ—ç™½', color: '#ffffff', src: '', affinity: 0, dialogueStyle: 'default' }, 'npc_1': { id: 'npc_1', name: 'è·¯äººç”²', color: '#b0b0b0', src: '', affinity: 0, dialogueStyle: 'default' } },
            scripts: [{ roleId:'narrator', text:"æ¬¢è¿ä½¿ç”¨ Galgame ç”Ÿæˆå™¨ V1.1ï¼è¯•ç€æ‹–æ‹½å·¦ä¾§çš„å°è¯è¡Œæ¥æ’åºå§ï¼", charScale: 1.0, charOpacity: 1.0, charVisible: false, bgType:'image', bgSrc:'', bgS:0, bgE:null, bgMuted: true, bgmType:'stop', bgmSrc:'', bgmS:0, bgmE:null, next:null, opts:[] }]
        };
        let curIdx = 0, trim = { active:false, file:null, type:'', media:'', s:0, e:null, player:null };
        let dragSrcIdx = -1; // æ‹–æ‹½æºç´¢å¼•

        window.onload = () => { renderPalette(); renderGame(0); };

        /* --- æ‹–æ‹½é€»è¾‘ --- */
        function handleDragStart(e, i) {
            dragSrcIdx = i;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
            e.target.classList.add('dragging');
        }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
        function handleDragEnter(e) { e.target.closest('.flow-node')?.classList.add('drag-over'); }
        function handleDragLeave(e) { e.target.closest('.flow-node')?.classList.remove('drag-over'); }
        function handleDrop(e, i) {
            e.stopPropagation();
            const targetNode = e.target.closest('.flow-node');
            if(targetNode) targetNode.classList.remove('drag-over');
            document.querySelectorAll('.flow-node').forEach(el => el.classList.remove('dragging'));

            if (dragSrcIdx !== i && dragSrcIdx !== -1) {
                const list = project.scripts;
                const item = list.splice(dragSrcIdx, 1)[0];
                list.splice(i, 0, item);
                
                // æ›´æ–°å½“å‰æ’­æ”¾ç´¢å¼•
                if (curIdx === dragSrcIdx) curIdx = i;
                else if (curIdx > dragSrcIdx && curIdx <= i) curIdx--;
                else if (curIdx < dragSrcIdx && curIdx >= i) curIdx++;

                renderFlowchart();
                renderGame(curIdx); // åˆ·æ–°è§†å›¾
            }
            return false;
        }

        /* --- æ¸²æŸ“å¼•æ“ --- */
        function renderGame(idx, isJump=false, affChange=0, affRole='') {
            if(idx<0 || idx>=project.scripts.length) return;
            if (isJump && affChange !== 0) showAffinityFeedback(affRole, affChange);

            const prevS = project.scripts[curIdx];
            curIdx = idx;
            const s = project.scripts[idx];
            const r = project.roles[s.roleId] || {name:'???', color:'#fff', src:'', dialogueStyle:'default'};
            
            const box = document.getElementById('dialogue-box');
            box.className = 'dialogue-box style-' + (r.dialogueStyle || 'default');

            const nameTag = document.getElementById('ui-name');
            nameTag.innerText = r.name==='æ—ç™½'?'':r.name;
            if(r.dialogueStyle!=='tech' && r.dialogueStyle!=='sweet' && r.dialogueStyle!=='retro') {
                 nameTag.style.background = r.name==='æ—ç™½' ? 'transparent' : (r.color || 'var(--soft-purple)');
                 nameTag.style.padding = r.name==='æ—ç™½' ? '0' : '4px 18px';
            } else { nameTag.style.background = ''; nameTag.style.padding = ''; }

            document.getElementById('ui-text').innerText = s.text;

            const charImg = document.getElementById('char-img');
            charImg.classList.remove('char-enter-anim');
            const shouldShow = (r.src && r.src !== "") && (s.charVisible !== false);
            
            if(shouldShow) {
                const wasHidden = charImg.classList.contains('hidden');
                const prevHidden = (!project.roles[prevS.roleId]?.src || prevS.charVisible === false);
                charImg.src = r.src;
                charImg.style.setProperty('--scale', s.charScale||1.0);
                charImg.style.setProperty('--opacity', s.charOpacity||1.0);
                charImg.style.transform = `scale(${s.charScale||1.0})`;
                charImg.style.opacity = s.charOpacity||1.0;
                charImg.classList.remove('hidden');
                if(wasHidden || prevHidden) { void charImg.offsetWidth; charImg.classList.add('char-enter-anim'); }
            } else { charImg.classList.add('hidden'); }

            updateMedia(idx, 'bg'); updateMedia(idx, 'bgm'); renderOpts(s);
            if(document.getElementById('tab-editor').classList.contains('active')) refreshEdit();
        }

        function renderFlowchart(){ 
            const l=document.getElementById('flowchart-container'); l.innerHTML="";
            project.scripts.forEach((s,i)=>{
                const r=project.roles[s.roleId]||{name:'???', color:'#999'};
                const d=document.createElement('div'); 
                d.className=`flow-node ${i===curIdx?'active':''}`;
                // å¯ç”¨æ‹–æ‹½
                d.draggable = true;
                d.ondragstart = (e) => handleDragStart(e, i);
                d.ondragover = handleDragOver;
                d.ondragenter = handleDragEnter;
                d.ondragleave = handleDragLeave;
                d.ondrop = (e) => handleDrop(e, i);
                d.onclick=()=>renderGame(i);

                // ç¾åŒ–åçš„å†…å®¹ç»“æ„
                d.innerHTML = `
                    <div class="drag-handle">â˜°</div>
                    <div class="flow-idx">${i+1}</div>
                    <div class="flow-role" style="background:${r.color||'#999'}">${r.name}</div>
                    <div class="flow-text">${s.text || '...'}</div>
                    ${(s.next||s.opts.length)?'<div style="width:8px;height:8px;border-radius:50%;background:var(--accent-color)"></div>':''}
                    <button class="flow-del" onclick="delS(${i},event)">Ã—</button>
                `;
                l.appendChild(d);
            });
        }

        /* --- å…¶ä»–æ ¸å¿ƒé€»è¾‘ä¿æŒä¸å˜ï¼Œä»…åšæ ·å¼é€‚é… --- */
        function refreshEdit() {
            const s = project.scripts[curIdx];
            document.getElementById('editor-idx').innerText = `è¡Œ ${curIdx+1} / ${project.scripts.length}`;
            const sel = document.getElementById('inp-role-id'); sel.innerHTML = '<option value="narrator">æ—ç™½</option>';
            Object.values(project.roles).forEach(r=>{if(r.id!=='narrator')sel.innerHTML+=`<option value="${r.id}">${r.name}</option>`});
            sel.value = s.roleId||"narrator";
            document.getElementById('inp-text').value = s.text;
            document.getElementById('inp-next').value = s.next||"";
            document.getElementById('inp-bg-type').value = s.bgType;
            document.getElementById('inp-bgm-type').value = s.bgmType;
            const hasSprite = project.roles[s.roleId] && project.roles[s.roleId].src;
            document.getElementById('inp-char-visible').checked = s.charVisible !== false;
            document.getElementById('inp-char-visible').disabled = !hasSprite;
            document.getElementById('video-control').style.display = (s.bgType === 'video') ? 'block' : 'none';
            document.getElementById('inp-video-mute').checked = s.bgMuted !== false;
            updateMuteText();
            document.getElementById('inp-scale').value = s.charScale || 1.0;
            document.getElementById('val-scale').innerText = (s.charScale || 1.0).toFixed(1);
            document.getElementById('inp-opacity').value = s.charOpacity || 1.0;
            document.getElementById('val-opacity').innerText = (s.charOpacity || 1.0).toFixed(1);
            toggleMedia(); renderFlowchart(); renderOptList();
        }

        function saveData() {
            const s = project.scripts[curIdx];
            s.roleId = document.getElementById('inp-role-id').value;
            s.text = document.getElementById('inp-text').value;
            s.next = document.getElementById('inp-next').value;
            s.bgType = document.getElementById('inp-bg-type').value;
            s.bgmType = document.getElementById('inp-bgm-type').value;
            s.charScale = parseFloat(document.getElementById('inp-scale').value);
            s.charOpacity = parseFloat(document.getElementById('inp-opacity').value);
            s.charVisible = document.getElementById('inp-char-visible').checked;
            s.bgMuted = (s.bgType === 'video') ? document.getElementById('inp-video-mute').checked : true;
            renderGame(curIdx); renderFlowchart();
        }
        
        function showAffinityFeedback(roleId, amount) {
            const el = document.getElementById('affinity-feedback');
            const role = project.roles[roleId] || { name: 'æœªçŸ¥' };
            el.classList.remove('aff-active');
            el.innerHTML = amount > 0 ? `<span style="color:#ff7675">ğŸ’— ${role.name} +${amount}</span>` : `<span style="color:#636e72">ğŸ’” ${role.name} ${amount}</span>`;
            void el.offsetWidth; el.classList.add('aff-active');
        }
        
        function updateMedia(idx, k) {
            let d=null; for(let i=idx; i>=0; i--) if(project.scripts[i][k+'Type']!=='inherit'){d=project.scripts[i];break;}
            const img=document.getElementById('bg-layer-img'), vid=document.getElementById('bg-layer-video'), aud=document.getElementById('bgm-player');
            if(!d || d[k+'Type']==='stop' || (k==='bg'&&d.bgType==='image' && !d.bgSrc)) {
                if(k==='bgm') { aud.pause(); aud.src = ""; }
                if(k==='bg') { vid.classList.add('hidden'); vid.pause(); img.classList.remove('hidden'); img.src = d?.bgSrc||""; }
                return;
            }
            const p = k==='bg'?vid:aud;
            if(k==='bg'){ img.classList.add('hidden'); if(d.bgType === 'video') { vid.classList.remove('hidden'); vid.muted = d.bgMuted !== false; } else { vid.classList.add('hidden'); } }
            const srcKey = k+'Src';
            if(p.dataset.src !== d[srcKey]) { p.src = d[srcKey]; p.dataset.src = d[srcKey]; p.currentTime = d[k+'S']||0; if(k==='bgm') { p.volume=0; p.play().catch(()=>{}); fadeIn(p); } else { p.play().catch(()=>{}); } }
            const end = d[k+'E']; const start = d[k+'S']||0;
            p.ontimeupdate = end ? ()=>{ if(p.currentTime>=end) p.currentTime=start; } : null; if(!end) p.loop=true;
        }

        function fadeIn(a) { let v=0; a.volume=0; const i=setInterval(()=>{ v+=0.05; if(v>=1){v=1;clearInterval(i);} a.volume=v;},50); }
        function toggleLayer(id, btn) { const el=document.getElementById(id); el.classList.toggle('hidden'); btn.classList.toggle('off'); }
        function updateMuteText() { const m = document.getElementById('inp-video-mute').checked; document.getElementById('mute-status-text').innerText = m ? "ğŸ”‡ é™éŸ³" : "ğŸ”Š åŸå£°"; }
        function updateSlider(k, v) { document.getElementById('val-'+k).innerText = parseFloat(v).toFixed(1); }
        
        function renderPalette() {
            const p = document.getElementById('color-palette'); p.innerHTML = "";
            COLORS.forEach(c => {
                const d = document.createElement('div'); d.className = 'color-swatch'; d.style.backgroundColor = c;
                d.onclick = () => { document.querySelectorAll('.color-swatch').forEach(el=>el.classList.remove('selected')); d.classList.add('selected'); document.getElementById('new-role-color').value = c; };
                p.appendChild(d);
            }); p.children[0].click();
        }
        
        function createRole() {
            const n = document.getElementById('new-role-name').value, c = document.getElementById('new-role-color').value, s = document.getElementById('new-role-style').value, f = document.getElementById('new-role-img').files[0];
            if(!n) return alert("è¯·è¾“å…¥åå­—");
            const id = 'r_'+Date.now();
            const finish = (src) => { project.roles[id] = { id, name:n, color:c, src, affinity:0, dialogueStyle: s }; renderCharGrid(); refreshEdit(); };
            if(f) { const r=new FileReader(); r.onload=e=>finish(e.target.result); r.readAsDataURL(f); } else finish("");
        }
        function renderCharGrid() {
            const g = document.getElementById('char-grid'); g.innerHTML="";
            Object.values(project.roles).forEach(r=>{
                if(r.id==='narrator') return;
                const d = document.createElement('div'); d.className='char-card'; d.style.borderColor = r.color;
                d.innerHTML = `<img src="${r.src}" onerror="this.style.opacity=0.3" style="border-color:${r.color}"><div style="font-weight:bold;margin-top:5px;">${r.name}</div><div style="font-size:12px;color:#888">${r.dialogueStyle}</div><div class="aff-val">ğŸ’“ ${r.affinity}</div><button class="btn btn-danger" onclick="delRole('${r.id}')" style="margin-top:10px;padding:5px 10px;font-size:12px;">åˆ é™¤</button>`;
                g.appendChild(d);
            });
        }
        function delRole(id){ if(confirm("ç¡®å®šåˆ é™¤?")) { delete project.roles[id]; renderCharGrid(); refreshEdit(); } }
        function resetAff() { if(confirm("é‡ç½®å¥½æ„Ÿåº¦?")) { Object.keys(project.roles).forEach(k=>project.roles[k].affinity=0); renderCharGrid(); } }
        
        function addNewScene() { project.scripts.push({roleId:'npc_1', text:'...', charScale:1, charOpacity:1, charVisible:true, bgType:'inherit', bgMuted:true, bgmType:'inherit', next:null, opts:[]}); renderGame(project.scripts.length-1); }
        function delS(i,e){e.stopPropagation(); if(project.scripts.length>1){project.scripts.splice(i,1); renderGame(Math.max(0,curIdx-1)); renderFlowchart();}}
        
        function renderOptList(){
            const l=document.getElementById('opt-list'); l.innerHTML="";
            project.scripts[curIdx].opts.forEach((o,i)=>{
                const d=document.createElement('div'); d.className="opt-row";
                let ro="<option value=''>æ— å˜åŒ–</option>"; 
                Object.values(project.roles).forEach(r=>{if(r.id!=='narrator')ro+=`<option value="${r.id}" ${o.role===r.id?'selected':''}>${r.name}</option>`});
                d.innerHTML=`<input value="${o.text}" onchange="updO(${i},'text',this.value)" style="flex:1 0 100%;" placeholder="é€‰é¡¹å†…å®¹"><span class="opt-label">è·³è½¬</span><input type="number" value="${o.next}" onchange="updO(${i},'next',this.value)" style="width:50px"><span class="opt-label">å¥½æ„Ÿ</span><select onchange="updO(${i},'role',this.value)" style="width:80px">${ro}</select><input type="number" value="${o.val}" onchange="updO(${i},'val',this.value)" style="width:50px"><button class="btn btn-danger" onclick="delO(${i})" style="width:30px;padding:0;margin-left:auto;">Ã—</button>`;
                l.appendChild(d);
            });
        }
        function addOpt(){ project.scripts[curIdx].opts.push({text:'é€‰é¡¹',next:curIdx+1,role:'',val:0}); refreshEdit(); renderFlowchart(); }
        function updO(i,k,v){ project.scripts[curIdx].opts[i][k]=v; renderGame(curIdx); renderFlowchart(); }
        function delO(i){ project.scripts[curIdx].opts.splice(i,1); refreshEdit(); renderFlowchart(); }
        
        function renderOpts(s){ 
            const l=document.getElementById('choice-layer'); l.innerHTML=""; 
            if(s.opts && s.opts.length>0){
                l.classList.remove('hidden'); document.getElementById('ui-layer').style.opacity=0.3;
                s.opts.forEach(o=>{
                    const b=document.createElement('button'); b.innerText=o.text; 
                    b.style="padding:15px 50px;font-size:20px;font-weight:bold;cursor:pointer;background:rgba(255,255,255,0.95);border:2px solid white;border-radius:16px;box-shadow:0 5px 15px rgba(0,0,0,0.1);min-width:300px;color:#333;transition:0.2s;";
                    b.onmouseover=()=>b.style.transform='scale(1.05)'; b.onmouseout=()=>b.style.transform='scale(1)';
                    b.onclick=()=>{ 
                        if(o.role && project.roles[o.role] && o.val!=0) { project.roles[o.role].affinity += parseInt(o.val); renderGame(parseInt(o.next)-1, true, parseInt(o.val), o.role); renderCharGrid(); }
                        else renderGame(parseInt(o.next)-1); 
                    };
                    l.appendChild(b);
                });
            } else { l.classList.add('hidden'); document.getElementById('ui-layer').style.opacity=1; }
        }
        function gameNext(){ const s=project.scripts[curIdx]; if(!s.opts.length) { const n=s.next?parseInt(s.next)-1:curIdx+1; if(n<project.scripts.length)renderGame(n); } }
        
        function toggleMedia(){ const bt=document.getElementById('inp-bg-type').value, mt=document.getElementById('inp-bgm-type').value; document.getElementById('btn-up-bg').style.display=(bt==='image'||bt==='video')?'block':'none'; document.getElementById('btn-up-bgm').style.display=(mt==='file')?'block':'none'; document.getElementById('video-control').style.display = (bt==='video')?'block':'none'; }
        function trigUp(k){ const t=document.getElementById('inp-'+k+'-type').value, i=document.getElementById('file-'+k); i.accept=(k==='bg'&&t==='image')?"image/*":(t==='video'?"video/*":"audio/*"); i.click(); }
        function handleFile(inp,k){ const f=inp.files[0]; if(!f)return; const s=project.scripts[curIdx]; if(f.type.startsWith('image')){ const r=new FileReader(); r.onload=e=>{s[k+'Src']=e.target.result; s[k+'Type']='image'; saveData();}; r.readAsDataURL(f); } else { trim={active:true,file:f,type:k,media:f.type.startsWith('video')?'video':'audio',s:0,e:null}; openTrim(); } inp.value=""; }
        function openTrim(){ const c=document.getElementById('trim-preview'); c.innerHTML=""; const url=URL.createObjectURL(trim.file); trim.player=document.createElement(trim.media==='video'?'video':'audio'); trim.player.src=url; trim.player.controls=true; trim.player.onloadedmetadata=()=>{document.getElementById('t-end').innerText=trim.player.duration.toFixed(2);}; c.appendChild(trim.player); document.getElementById('trimmer-modal').style.display="flex"; }
        function setTrim(p){ const t=trim.player.currentTime; if(p==='s'){trim.s=t;document.getElementById('t-start').innerText=t.toFixed(2);}else{trim.e=t;document.getElementById('t-end').innerText=t.toFixed(2);} }
        function closeTrim(){ document.getElementById('trimmer-modal').style.display="none"; trim.player.pause(); URL.revokeObjectURL(trim.player.src); }
        function confirmTrim(){ const r=new FileReader(); r.onload=e=>{ const s=project.scripts[curIdx]; s[trim.type+'Src']=e.target.result; s[trim.type+'Type']=trim.media==='video'?'video':'file'; s[trim.type+'S']=trim.s; s[trim.type+'E']=trim.e; if(trim.media==='video') s.bgMuted=s.bgMuted===undefined?true:s.bgMuted; closeTrim(); renderGame(curIdx); }; r.readAsDataURL(trim.file); }
        
        function toggleFS(){ const e=document.getElementById('stage-wrapper'); if(!document.fullscreenElement)e.requestFullscreen().catch(()=>{}); else document.exitFullscreen(); }
        function exportProj(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(project)],{type:"application/json"})); a.download="gal_project_v1.1.json"; a.click(); }
        function importProj(i){ const r=new FileReader(); r.onload=e=>{ try{ project=JSON.parse(e.target.result); renderGame(0); refreshEdit(); }catch(x){alert("æ–‡ä»¶æ— æ•ˆ");} }; if(i.files[0])r.readAsText(i.files[0]); }
        function switchTab(t){ document.querySelectorAll('.main-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); if(t==='editor') refreshEdit(); else renderCharGrid(); }
    </script>
</body>
</html>